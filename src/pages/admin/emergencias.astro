---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

type EmergencyRow = {
  id: string;
  emergencyId: string;
  paciente: string;
  rut: string;
  estado: string;
  box: string;
  motivo: string;
  resumen: string;
  signosVitales: string;
  alergias: string;
  doctor: string | null;
  nurse: string | null;
  createdAt: Date | null;
  finishedAt: Date | null;
};

const formatWorkerName = (
  worker:
    | {
        primer_nombre_trabajador: string | null;
        segundo_nombre_trabajador: string | null;
        apellido_p_trabajador: string | null;
        apellido_m_trabajador: string | null;
      }
    | null
    | undefined,
) =>
  worker
    ? [
        worker.primer_nombre_trabajador,
        worker.segundo_nombre_trabajador,
        worker.apellido_p_trabajador,
        worker.apellido_m_trabajador,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null
    : null;

let emergencies: EmergencyRow[] = [];
let loadError: string | null = null;

try {
  const rows = await prisma.emergencyAttention.findMany({
    where: { finished_at: { not: null } },
    orderBy: [{ finished_at: "desc" }, { id: "desc" }],
    take: 200,
    include: {
      emergencia: true,
      doctor: {
        select: {
          primer_nombre_trabajador: true,
          segundo_nombre_trabajador: true,
          apellido_p_trabajador: true,
          apellido_m_trabajador: true,
        },
      },
      nurse: {
        select: {
          primer_nombre_trabajador: true,
          segundo_nombre_trabajador: true,
          apellido_p_trabajador: true,
          apellido_m_trabajador: true,
        },
      },
    },
  });

  emergencies = rows.map((row): EmergencyRow => ({
    id: row.id.toString(),
    emergencyId: row.emergencia_id.toString(),
    paciente: row.emergencia?.fullName ?? "Sin nombre",
    rut: row.emergencia?.rut ?? "Sin RUT",
    estado: row.estado ?? "Sin estado",
    box: row.box ?? "Sin box",
    motivo: row.motivo ?? "Sin motivo",
    resumen: row.resumen ?? "Sin resumen",
    signosVitales: row.signos_vitales ?? "Sin registro",
    alergias: row.alergias ?? "Sin registro",
    doctor: formatWorkerName(row.doctor),
    nurse: formatWorkerName(row.nurse),
    createdAt: row.emergencia?.createdAt ?? null,
    finishedAt: row.finished_at ?? null,
  }));
} catch (error) {
  console.error("admin emergencias list error", error);
  loadError = "No pudimos cargar las emergencias. Intenta mas tarde.";
}

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin fecha";
---

<Layout title="Emergencias realizadas">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 text-white">
        <div>
          <p class="text-sm uppercase tracking-[0.35em] text-white/70">Equipo</p>
          <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Emergencias realizadas</h1>
          <p class="mt-2 max-w-3xl text-white/80">
            Visualiza las emergencias finalizadas por enfermeria y su informacion clinica registrada.
          </p>
        </div>
        <a
          href="/admin"
          class="inline-flex items-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
        >
          Volver al panel
        </a>
      </header>

      <article class="rounded-3xl bg-white p-6 shadow-xl">
        {loadError ? (
          <div class="rounded-2xl border border-dashed border-rose-200 bg-rose-50 px-4 py-6 text-sm text-rose-700">
            {loadError}
          </div>
        ) : emergencies.length > 0 ? (
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#200934]/10 text-sm text-[#200934]/80">
              <thead class="bg-[#f9f7ff] text-[#200934]">
                <tr>
                  <th class="px-3 py-3 text-left font-semibold">ID</th>
                  <th class="px-3 py-3 text-left font-semibold">Paciente</th>
                  <th class="px-3 py-3 text-left font-semibold">RUT</th>
                  <th class="px-3 py-3 text-left font-semibold">Estado</th>
                  <th class="px-3 py-3 text-left font-semibold">Box</th>
                  <th class="px-3 py-3 text-left font-semibold">Ingreso</th>
                  <th class="px-3 py-3 text-left font-semibold">Finalizada</th>
                  <th class="px-3 py-3 text-left font-semibold">Medico</th>
                  <th class="px-3 py-3 text-left font-semibold">Enfermeria</th>
                  <th class="px-3 py-3 text-left font-semibold">Motivo</th>
                  <th class="px-3 py-3 text-left font-semibold">Resumen</th>
                  <th class="px-3 py-3 text-left font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[#200934]/10">
                {emergencies.map((item) => (
                  <tr class="hover:bg-[#f9f7ff]">
                    <td class="px-3 py-3 font-semibold text-[#200934]">#{item.emergencyId}</td>
                    <td class="px-3 py-3">{item.paciente}</td>
                    <td class="px-3 py-3">{item.rut}</td>
                    <td class="px-3 py-3">{item.estado}</td>
                    <td class="px-3 py-3">{item.box}</td>
                    <td class="px-3 py-3">{formatDateTime(item.createdAt)}</td>
                    <td class="px-3 py-3">{formatDateTime(item.finishedAt)}</td>
                    <td class="px-3 py-3">{item.doctor ?? "Sin medico"}</td>
                    <td class="px-3 py-3">{item.nurse ?? "Sin registro"}</td>
                    <td class="px-3 py-3 max-w-[220px] align-top">
                      <p class="line-clamp-2">{item.motivo}</p>
                      <p class="mt-1 text-[11px] text-[#200934]/60">Signos: {item.signosVitales}</p>
                      <p class="text-[11px] text-[#200934]/60">Alergias: {item.alergias}</p>
                    </td>
                    <td class="px-3 py-3 max-w-[220px] align-top">
                      <p class="line-clamp-3">{item.resumen}</p>
                    </td>
                    <td class="px-3 py-3">
                      <a
                        href={`/admin/emergencias/${item.emergencyId}`}
                        class="inline-flex items-center rounded-2xl bg-[#321355] px-3 py-2 text-xs font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#321355]"
                      >
                        Editar
                      </a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="rounded-2xl border border-dashed border-[#200934]/20 bg-[#faf7ff] px-4 py-6 text-sm text-[#200934]/70">
            Aun no hay emergencias finalizadas.
          </div>
        )}
      </article>
    </div>
  </section>
</Layout>
