---
import Layout from "../../../layouts/Layout.astro";
import { prisma } from "../../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

const idParam = Astro.params.id ?? "";

let emergencyId: bigint;
try {
  emergencyId = BigInt(idParam);
  if (emergencyId <= 0) {
    return Astro.redirect("/admin/emergencias");
  }
} catch {
  return Astro.redirect("/admin/emergencias");
}

const attention = await prisma.emergencyAttention.findUnique({
  where: { emergencia_id: emergencyId },
  include: {
    emergencia: true,
    doctor: {
      select: {
        primer_nombre_trabajador: true,
        segundo_nombre_trabajador: true,
        apellido_p_trabajador: true,
        apellido_m_trabajador: true,
      },
    },
    nurse: {
      select: {
        primer_nombre_trabajador: true,
        segundo_nombre_trabajador: true,
        apellido_p_trabajador: true,
        apellido_m_trabajador: true,
      },
    },
  },
});

if (!attention || !attention.emergencia) {
  return Astro.redirect("/admin/emergencias");
}

const doctors = await prisma.trabajador.findMany({
  where: { cargo: "MEDICO" },
  select: {
    id_trabajador: true,
    primer_nombre_trabajador: true,
    segundo_nombre_trabajador: true,
    apellido_p_trabajador: true,
    apellido_m_trabajador: true,
    especialidad: { select: { nombre_especialidad: true } },
  },
  orderBy: [{ primer_nombre_trabajador: "asc" }, { apellido_p_trabajador: "asc" }],
});

const formatWorkerName = (
  worker:
    | {
        primer_nombre_trabajador: string | null;
        segundo_nombre_trabajador: string | null;
        apellido_p_trabajador: string | null;
        apellido_m_trabajador: string | null;
      }
    | null
    | undefined,
) =>
  worker
    ? [
        worker.primer_nombre_trabajador,
        worker.segundo_nombre_trabajador,
        worker.apellido_p_trabajador,
        worker.apellido_m_trabajador,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null
    : null;

const formatDoctorName = (doctor: (typeof doctors)[number]) =>
  [
    doctor.primer_nombre_trabajador,
    doctor.segundo_nombre_trabajador,
    doctor.apellido_p_trabajador,
    doctor.apellido_m_trabajador,
  ]
    .filter(Boolean)
    .join(" ");

const emergency = attention.emergencia;
const defaultDoctorId = attention.doctor_id ? attention.doctor_id.toString() : "";
const nurseName = formatWorkerName(attention.nurse) ?? "Sin registro";
const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin fecha";
---

<Layout title="Editar emergencia">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 text-white">
        <div>
          <p class="text-sm uppercase tracking-[0.35em] text-white/70">Equipo</p>
          <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Editar emergencia #{emergency.id.toString()}</h1>
          <p class="mt-2 max-w-3xl text-white/80">
            Actualiza la informacion registrada en la atencion de emergencia finalizada.
          </p>
        </div>
        <a
          href="/admin/emergencias"
          class="inline-flex items-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
        >
          Volver al listado
        </a>
      </header>

      <div class="grid gap-6 lg:grid-cols-2">
        <article class="rounded-3xl bg-white p-6 shadow-xl">
          <p class="text-sm font-semibold uppercase tracking-[0.2em] text-[#321355]/80">Datos del paciente</p>
          <div class="mt-3 grid gap-2 text-sm text-[#200934]/80">
            <p class="text-lg font-bold text-[#200934]">{emergency.fullName}</p>
            <p>RUT: {emergency.rut}</p>
            <p>Telefono: {emergency.phone}</p>
            <p>Edad: {emergency.age}</p>
            <p>Fecha de nacimiento: {new Date(emergency.birthdate).toLocaleDateString("es-CL")}</p>
            <p>Sexo: {emergency.sex}</p>
            <p>Direccion: {emergency.address}</p>
            <p class="text-xs text-[#200934]/60">Ingreso: {formatDateTime(emergency.createdAt)}</p>
            <p class="text-xs text-[#200934]/60">Finalizada: {formatDateTime(attention.finished_at)}</p>
            <p class="text-xs text-[#200934]/60">Enfermeria: {nurseName}</p>
          </div>
        </article>

        <article class="rounded-3xl bg-white p-6 shadow-xl">
          <form
            data-emergency-edit-form
            data-emergency-id={emergency.id.toString()}
            class="grid gap-4"
          >
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
                Numero de box
                <input
                  type="text"
                  name="box"
                  value={attention.box ?? ""}
                  placeholder="Ej: Box 2"
                  class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-normal text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
                />
              </label>

              <div class="flex flex-col gap-2">
                <p class="text-sm font-semibold text-[#200934]">Estado del paciente</p>
                <div class="flex flex-wrap gap-3">
                  <label class="flex cursor-pointer items-center gap-2 rounded-full border border-[#200934]/15 px-3 py-2 text-sm font-semibold text-[#200934] shadow-sm transition hover:border-[#321355]/40">
                    <input
                      type="radio"
                      name="estado"
                      value="consciente"
                      class="text-[#321355]"
                      checked={attention.estado === "consciente"}
                    />
                    Consciente
                  </label>
                  <label class="flex cursor-pointer items-center gap-2 rounded-full border border-[#200934]/15 px-3 py-2 text-sm font-semibold text-[#200934] shadow-sm transition hover:border-[#321355]/40">
                    <input
                      type="radio"
                      name="estado"
                      value="inconsciente"
                      class="text-[#321355]"
                      checked={attention.estado === "inconsciente"}
                    />
                    Inconsciente
                  </label>
                </div>
              </div>
            </div>

            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Motivo de la emergencia
              <textarea
                name="motivo"
                rows="3"
                placeholder="Dolor toracico, paro respiratorio, etc."
                class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-normal text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
              >{attention.motivo ?? ""}</textarea>
            </label>

            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Signos vitales
              <textarea
                name="signosVitales"
                rows="3"
                placeholder="Ej: PA 120/80, FC 85, FR 18, SatO2 96%, Temp 36.7"
                class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-normal text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
              >{attention.signos_vitales ?? ""}</textarea>
            </label>

            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Alergias
              <textarea
                name="alergias"
                rows="3"
                placeholder="Ej: Alergia a penicilina."
                class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-normal text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
              >{attention.alergias ?? ""}</textarea>
            </label>

            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Resumen
              <textarea
                name="resumen"
                rows="4"
                placeholder="Notas de la atencion."
                class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-normal text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
              >{attention.resumen ?? ""}</textarea>
            </label>

            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Medico a cargo
              <select
                name="doctorId"
                data-doctor-select
                data-default-id={defaultDoctorId}
                class="rounded-2xl border border-[#200934]/15 bg-white px-4 py-3 text-base font-medium text-[#200934] shadow-inner outline-none transition focus:border-[#321355] focus:ring-2 focus:ring-[#321355]/20"
              >
                <option value="">Sin asignar</option>
                {doctors.map((doctor) => {
                  const label = formatDoctorName(doctor);
                  const specialty = doctor.especialidad?.nombre_especialidad ?? "Sin especialidad";
                  return (
                    <option value={doctor.id_trabajador} selected={String(doctor.id_trabajador) === defaultDoctorId}>
                      {label} - {specialty}
                    </option>
                  );
                })}
              </select>
            </label>

            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <a
                href="/admin/emergencias"
                class="inline-flex items-center justify-center rounded-2xl border border-[#200934]/15 px-4 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#321355]/40"
              >
                Cancelar
              </a>
              <button
                type="submit"
                data-submit-btn
                class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-6 py-3 text-sm font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
              >
                Guardar cambios
              </button>
            </div>

            <p data-success-msg class="hidden rounded-2xl bg-green-50 px-4 py-3 text-sm font-semibold text-green-700 shadow-inner"></p>
            <p data-error-msg class="hidden rounded-2xl bg-red-50 px-4 py-3 text-sm font-semibold text-red-700 shadow-inner"></p>
          </form>
        </article>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("[data-emergency-edit-form]");
      const doctorSelect = document.querySelector("[data-doctor-select]");
      const submitBtn = document.querySelector("[data-submit-btn]");
      const successMsg = document.querySelector("[data-success-msg]");
      const errorMsg = document.querySelector("[data-error-msg]");

      if (doctorSelect instanceof HTMLSelectElement) {
        const defaultId = doctorSelect.dataset.defaultId ?? "";
        if (defaultId) {
          doctorSelect.value = defaultId;
        }
      }

      form?.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!(form instanceof HTMLFormElement)) return;

        successMsg?.classList.add("hidden");
        errorMsg?.classList.add("hidden");

        const formData = new FormData(form);
        const payload = {
          emergencyId: form.dataset.emergencyId ?? "",
          box: String(formData.get("box") ?? "").trim(),
          estado: String(formData.get("estado") ?? "").trim(),
          motivo: String(formData.get("motivo") ?? "").trim(),
          signosVitales: String(formData.get("signosVitales") ?? "").trim(),
          alergias: String(formData.get("alergias") ?? "").trim(),
          resumen: String(formData.get("resumen") ?? "").trim(),
          doctorId: String(formData.get("doctorId") ?? "").trim(),
        };

        try {
          if (submitBtn instanceof HTMLButtonElement) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Guardando...";
          }

          const response = await fetch("/api/admin/emergencias", {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json().catch(() => null);

          if (!response.ok || !result) {
            throw new Error(result?.error ?? "No pudimos actualizar la emergencia.");
          }

          if (successMsg) {
            successMsg.textContent = result.message ?? "Emergencia actualizada.";
            successMsg.classList.remove("hidden");
          }
          window.location.href = "/admin/emergencias";
        } catch (error) {
          if (errorMsg) {
            errorMsg.textContent =
              error instanceof Error ? error.message : "Ocurrio un error inesperado.";
            errorMsg.classList.remove("hidden");
          }
        } finally {
          if (submitBtn instanceof HTMLButtonElement) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Guardar cambios";
          }
        }
      });
    });
  </script>
</Layout>
