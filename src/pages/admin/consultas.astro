---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

type ConsultaListado = {
  id_consulta: number;
  id_disponibilidad: number | null;
  id_paciente: number | null;
  resumen: string;
  derivacion: string | null;
  tratamiento: unknown;
  orden_examenes: string | null;
  created_at: Date | null;
  updated_at: Date | null;
  fecha_slot: Date | null;
  estado_slot: string | null;
  paciente: string | null;
  trabajador: string | null;
  especialidad: string | null;
};

let consultas: ConsultaListado[] | null = null;
let loadError: string | null = null;

try {
  const rows = await prisma.consultaMedicaSlot.findMany({
    orderBy: [{ created_at: "desc" }, { id_consulta: "desc" }],
    include: {
      disponibilidad: {
        select: {
          fecha: true,
          estado: true,
          trabajador: {
            select: {
              primer_nombre_trabajador: true,
              segundo_nombre_trabajador: true,
              apellido_p_trabajador: true,
              apellido_m_trabajador: true,
              especialidad: { select: { nombre_especialidad: true } },
            },
          },
        },
      },
      paciente: {
        select: {
          primer_nombre_paciente: true,
          segundo_nombre_paciente: true,
          apellido_p_paciente: true,
          apellido_m_paciente: true,
        },
      },
    },
  });

  consultas = rows.map((row): ConsultaListado => {
    const nombrePaciente =
      [
        row.paciente?.primer_nombre_paciente,
        row.paciente?.segundo_nombre_paciente,
        row.paciente?.apellido_p_paciente,
        row.paciente?.apellido_m_paciente,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null;

    const nombreTrabajador =
      [
        row.disponibilidad?.trabajador?.primer_nombre_trabajador,
        row.disponibilidad?.trabajador?.segundo_nombre_trabajador,
        row.disponibilidad?.trabajador?.apellido_p_trabajador,
        row.disponibilidad?.trabajador?.apellido_m_trabajador,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null;

    return {
      id_consulta: row.id_consulta,
      id_disponibilidad: row.id_disponibilidad,
      id_paciente: row.id_paciente,
      resumen: row.resumen,
      derivacion: row.derivacion,
      tratamiento: row.tratamiento,
      orden_examenes: row.orden_examenes,
      created_at: row.created_at ?? null,
      updated_at: row.updated_at ?? null,
      fecha_slot: row.disponibilidad?.fecha ?? null,
      estado_slot: row.disponibilidad?.estado ?? null,
      paciente: nombrePaciente,
      trabajador: nombreTrabajador,
      especialidad: row.disponibilidad?.trabajador?.especialidad?.nombre_especialidad ?? null,
    };
  });
} catch (error) {
  console.error("admin consultas list error", error);
  loadError = "No pudimos cargar las consultas. Intenta mas tarde.";
  consultas = [];
}

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin fecha";
---

<Layout title="Consultas registradas">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 text-white">
        <div>
          <p class="text-sm uppercase tracking-[0.35em] text-white/70">Equipo</p>
          <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Consultas realizadas</h1>
          <p class="mt-2 max-w-3xl text-white/80">
            Revisa todas las consultas medicas registradas. Selecciona una para ver y editar su detalle.
          </p>
        </div>
        <a
          href="/admin"
          class="inline-flex items-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
        >
          Volver al panel
        </a>
      </header>

      <article class="rounded-3xl bg-white p-6 shadow-xl">
        {loadError ? (
          <div class="rounded-2xl border border-dashed border-rose-200 bg-rose-50 px-4 py-6 text-sm text-rose-700">
            {loadError}
          </div>
        ) : consultas && consultas.length > 0 ? (
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#200934]/10 text-sm text-[#200934]/80">
              <thead class="bg-[#f9f7ff] text-[#200934]">
                <tr>
                  <th class="px-3 py-3 text-left font-semibold">ID</th>
                  <th class="px-3 py-3 text-left font-semibold">Paciente</th>
                  <th class="px-3 py-3 text-left font-semibold">Profesional</th>
                  <th class="px-3 py-3 text-left font-semibold">Especialidad</th>
                  <th class="px-3 py-3 text-left font-semibold">Fecha</th>
                  <th class="px-3 py-3 text-left font-semibold">Resumen</th>
                  <th class="px-3 py-3 text-left font-semibold">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[#200934]/10">
                {consultas.map((consulta) => (
                  <tr class="hover:bg-[#f9f7ff]">
                    <td class="px-3 py-3 font-semibold text-[#200934]">#{consulta.id_consulta}</td>
                    <td class="px-3 py-3">{consulta.paciente ?? "Sin paciente"}</td>
                    <td class="px-3 py-3">{consulta.trabajador ?? "Sin asignar"}</td>
                    <td class="px-3 py-3">{consulta.especialidad ?? "Sin especialidad"}</td>
                    <td class="px-3 py-3">{formatDateTime(consulta.fecha_slot ?? consulta.created_at)}</td>
                    <td class="px-3 py-3 line-clamp-2">{consulta.resumen ?? "Sin resumen"}</td>
                    <td class="px-3 py-3">
                      <a
                        href={`/admin/consultas/${consulta.id_consulta}`}
                        class="inline-flex items-center rounded-2xl bg-[#321355] px-3 py-2 text-xs font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-[#321355]"
                      >
                        Ver / Editar
                      </a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div class="rounded-2xl border border-dashed border-[#200934]/20 bg-[#faf7ff] px-4 py-6 text-sm text-[#200934]/70">
            Aun no se registran consultas medicas.
          </div>
        )}
      </article>
    </div>
  </section>
</Layout>
