---
import Layout from "../../../layouts/Layout.astro";
import { prisma } from "../../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

const idParam = Number(Astro.params.id);

if (!Number.isInteger(idParam) || idParam <= 0) {
  return Astro.redirect("/admin/consultas");
}

type ConsultaDetalle = {
  id_consulta: number;
  id_disponibilidad: number | null;
  id_paciente: number | null;
  id_especialidad_trabajador: number | null;
  resumen: string;
  derivacion: string | null;
  diagnostico: string | null;
  tratamiento: unknown;
  orden_examenes: string | null;
  created_at: Date | null;
  updated_at: Date | null;
  fecha_slot: Date | null;
  estado_slot: string | null;
  paciente: string | null;
  trabajador: string | null;
  especialidad: string | null;
};

const obtenerConsulta = async (consultaId: number): Promise<ConsultaDetalle | null> => {
  try {
    const row = await prisma.consultaMedicaSlot.findFirst({
      where: { id_consulta: consultaId },
      include: {
        disponibilidad: {
          select: {
            fecha: true,
            estado: true,
            trabajador: {
              select: {
                id_especialidad: true,
                primer_nombre_trabajador: true,
                segundo_nombre_trabajador: true,
                apellido_p_trabajador: true,
                apellido_m_trabajador: true,
                especialidad: { select: { nombre_especialidad: true } },
              },
            },
          },
        },
        paciente: {
          select: {
            primer_nombre_paciente: true,
            segundo_nombre_paciente: true,
            apellido_p_paciente: true,
            apellido_m_paciente: true,
          },
        },
      },
    });

    if (!row) return null;

    const nombrePaciente = [row.paciente?.primer_nombre_paciente, row.paciente?.segundo_nombre_paciente, row.paciente?.apellido_p_paciente, row.paciente?.apellido_m_paciente]
      .filter(Boolean)
      .join(" ")
      .trim() || null;

    const nombreTrabajador = [
      row.disponibilidad?.trabajador?.primer_nombre_trabajador,
      row.disponibilidad?.trabajador?.segundo_nombre_trabajador,
      row.disponibilidad?.trabajador?.apellido_p_trabajador,
      row.disponibilidad?.trabajador?.apellido_m_trabajador,
    ]
      .filter(Boolean)
      .join(" ")
      .trim() || null;

    return {
      id_consulta: row.id_consulta,
      id_disponibilidad: row.id_disponibilidad,
      id_paciente: row.id_paciente,
      id_especialidad_trabajador: row.disponibilidad?.trabajador?.id_especialidad ?? null,
      resumen: row.resumen,
      derivacion: row.derivacion,
      diagnostico: row.diagnostico,
      tratamiento: row.tratamiento,
      orden_examenes: row.orden_examenes,
      created_at: row.created_at ?? null,
      updated_at: row.updated_at ?? null,
      fecha_slot: row.disponibilidad?.fecha ?? null,
      estado_slot: row.disponibilidad?.estado ?? null,
      paciente: nombrePaciente,
      trabajador: nombreTrabajador,
      especialidad: row.disponibilidad?.trabajador?.especialidad?.nombre_especialidad ?? null,
    };
  } catch (error) {
    console.error("admin consulta detail error", error);
    return null;
  }
};

const consulta = await obtenerConsulta(idParam);

if (!consulta) {
  return Astro.redirect("/admin/consultas");
}

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin fecha";

const especialidades = await prisma.especialidad.findMany({
  orderBy: { nombre_especialidad: "asc" },
});

const especialidadesClinicas = especialidades.filter(
  (opt) => !["administracion", "recepcion"].includes(opt.nombre_especialidad.toLowerCase()),
);

const diagnosticoCatalogo = consulta.id_especialidad_trabajador
  ? await prisma.enfermedadEspecialidad.findMany({
      where: { id_especialidad: consulta.id_especialidad_trabajador },
      orderBy: { nombre_enfermedad: "asc" },
    })
  : await prisma.enfermedadEspecialidad.findMany({
      orderBy: [{ id_especialidad: "asc" }, { nombre_enfermedad: "asc" }],
    });

const diagnosticoOptions = Array.from(
  new Map(
    diagnosticoCatalogo
      .map((item) => item.nombre_enfermedad?.trim())
      .filter(Boolean)
      .map((name) => [name.toLowerCase(), name]),
  ).values(),
);

const hasCustomDiagnostico =
  consulta.diagnostico &&
  !diagnosticoOptions.some(
    (opt) => opt.toLowerCase() === (consulta.diagnostico ?? "").toLowerCase(),
  );

const hasCustomDerivacion =
  consulta.derivacion &&
  !especialidadesClinicas.some(
    (opt) => opt.nombre_especialidad.toLowerCase() === consulta.derivacion?.toLowerCase(),
  );

type ExamenEspecialidadItem = {
  nombre_examen: string;
  especialidad?: { nombre_especialidad: string } | null;
};

type MedicamentoEspecialidadItem = { nombre_medicamento: string; especialidad?: { nombre_especialidad: string } | null };

const examenesCatalogo: ExamenEspecialidadItem[] = (prisma as any).examenEspecialidad?.findMany
  ? ((await (prisma as any).examenEspecialidad.findMany({
      orderBy: [{ id_especialidad: "asc" }, { nombre_examen: "asc" }],
      include: { especialidad: { select: { nombre_especialidad: true } } },
    })) as ExamenEspecialidadItem[])
  : [];

const examenesDatalist = Array.from(new Set(examenesCatalogo.map((item) => item.nombre_examen))).sort();

const medicamentosCatalogo: MedicamentoEspecialidadItem[] = (prisma as any).medicamentoEspecialidad?.findMany
  ? await (prisma as any).medicamentoEspecialidad.findMany({
      orderBy: [{ id_especialidad: "asc" }, { nombre_medicamento: "asc" }],
      include: { especialidad: { select: { nombre_especialidad: true } } },
    })
  : [];

const medicamentosSugeridos = Array.from(
  new Set(medicamentosCatalogo.map((item) => item.nombre_medicamento)),
).sort();

const catalogData = JSON.stringify({
  medicamentos: medicamentosSugeridos,
  examenes: examenesCatalogo.map((item) => ({
    nombre: item.nombre_examen,
    especialidad: item.especialidad?.nombre_especialidad ?? "",
  })),
  tratamientos: Array.isArray(consulta.tratamiento) ? consulta.tratamiento : [],
});
---

<Layout title={`Consulta #${consulta.id_consulta}`}>
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 text-white">
        <div>
          <p class="text-sm uppercase tracking-[0.35em] text-white/70">Equipo</p>
          <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Consulta #{consulta.id_consulta}</h1>
          <p class="mt-2 max-w-3xl text-white/80">
            Detalle completo de la consulta registrada. Puedes actualizar el resumen, derivación, tratamiento u órdenes de examen.
          </p>
        </div>
        <a
          href="/admin/consultas"
          class="inline-flex items-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
        >
          Volver al listado
        </a>
      </header>

      <div class="grid gap-6 lg:grid-cols-5">
        <article class="lg:col-span-2 space-y-3 rounded-3xl bg-white p-6 text-sm text-[#200934]/80 shadow-lg">
          <h2 class="text-xl font-semibold text-[#200934]">Resumen del caso</h2>
          <p><span class="font-semibold">Paciente:</span> {consulta.paciente ?? "Sin paciente"}</p>
          <p><span class="font-semibold">Profesional:</span> {consulta.trabajador ?? "Sin asignar"}</p>
          <p><span class="font-semibold">Especialidad:</span> {consulta.especialidad ?? "Sin especialidad"}</p>
          <p><span class="font-semibold">Fecha bloque:</span> {formatDateTime(consulta.fecha_slot)}</p>
          <p><span class="font-semibold">Estado bloque:</span> {consulta.estado_slot ?? "Sin estado"}</p>
          <p><span class="font-semibold">Creada:</span> {formatDateTime(consulta.created_at)}</p>
          <p><span class="font-semibold">Última actualización:</span> {formatDateTime(consulta.updated_at)}</p>
        </article>

        <article class="lg:col-span-3 rounded-3xl bg-white p-6 shadow-lg">
          <h2 class="text-xl font-semibold text-[#200934]">Editar consulta</h2>
          <p class="mt-1 text-sm text-[#200934]/70">Ajusta los mismos campos que completa el médico al registrar la consulta.</p>

          <form id="consulta-edit-form" class="mt-4 space-y-4">
            <input type="hidden" id="consultaId" value={consulta.id_consulta} />

            <div>
              <label class="mb-2 block text-sm font-semibold text-[#200934]" for="resumen">Resumen de la consulta</label>
              <textarea
                id="resumen"
                name="resumen"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                rows="3"
              >{consulta.resumen ?? ""}</textarea>
            </div>

            <div>
              <label class="mb-2 block text-sm font-semibold text-[#200934]" for="derivacion">Derivación</label>
              <select
                id="derivacion"
                name="derivacion"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              >
                <option value="" selected={consulta.derivacion === null || consulta.derivacion === ""}>
                  Sin derivación
                </option>
                {especialidades.map((opt) => (
                  <option
                    value={opt.nombre_especialidad}
                    selected={opt.nombre_especialidad === (consulta.derivacion ?? "")}
                  >
                    {opt.nombre_especialidad}
                  </option>
                ))}
                {hasCustomDerivacion ? (
                  <option value={consulta.derivacion ?? ""} selected>
                    {`Actual: ${consulta.derivacion}`}
                  </option>
                ) : null}
              </select>
              <p class="mt-1 text-xs text-[#200934]/60">Selecciona la especialidad a la que se derivará al paciente.</p>
            </div>

            <div>
              <label class="mb-2 block text-sm font-semibold text-[#200934]" for="diagnostico">Posible diagnóstico</label>
              <select
                id="diagnostico"
                name="diagnostico"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              >
                <option value="" selected={!consulta.diagnostico}>
                  Sin diagnóstico
                </option>
                {diagnosticoOptions.map((nombre) => (
                  <option value={nombre} selected={nombre === (consulta.diagnostico ?? "")}>
                    {nombre}
                  </option>
                ))}
                {hasCustomDiagnostico ? (
                  <option value={consulta.diagnostico ?? ""} selected>
                    {`Actual: ${consulta.diagnostico}`}
                  </option>
                ) : null}
                {diagnosticoOptions.length === 0 ? (
                  <option disabled>No hay diagnósticos configurados</option>
                ) : null}
              </select>
              <p class="mt-1 text-xs text-[#200934]/60">Elige el diagnóstico registrado en la consulta.</p>
            </div>

            <div class="rounded-2xl bg-[#f4f1fb] px-4 py-3">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold text-[#200934]">Tratamientos</p>
                <span class="text-xs font-semibold text-[#200934]/60">Opcional</span>
              </div>
              <p class="mt-1 text-xs text-[#200934]/70">Agrega medicamentos con frecuencia y duración, o deja notas libres.</p>
              <div class="mt-3 grid gap-3 md:grid-cols-3">
                <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                  Medicamento
                  <input
                    id="tratamientoMedicamento"
                    list="medicamentos-list"
                    class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                    placeholder="Ej: Paracetamol 500mg"
                  />
                  <datalist id="medicamentos-list">
                    {medicamentosSugeridos.map((med) => (
                      <option value={med}></option>
                    ))}
                  </datalist>
                </label>
                <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                  Frecuencia
                  <input
                    id="tratamientoFrecuencia"
                    type="text"
                    class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                    placeholder="Ej: 1 cada 8 horas"
                  />
                </label>
                <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                  Duración
                  <input
                    id="tratamientoDuracion"
                    type="text"
                    class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                    placeholder="Ej: 7 días"
                  />
                </label>
              </div>
              <button
                type="button"
                class="mt-3 inline-flex rounded-2xl bg-[#321355] px-4 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
                data-add-treatment
              >
                Agregar tratamiento
              </button>
              {medicamentosSugeridos.length === 0 && (
                <p class="mt-2 text-xs text-rose-600">No hay medicamentos sugeridos para esta especialidad.</p>
              )}
              <ul class="mt-4 space-y-2 text-sm text-[#200934]" data-treatment-list></ul>
              <div class="mt-4">
                <label class="mb-1 block text-xs font-semibold text-[#200934]" for="tratamientoLibre">Notas libres de tratamiento</label>
                <textarea
                  id="tratamientoLibre"
                  class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                  rows="3"
                  placeholder="Ej: Ajustar dosis según evolución, controles en 48h"
                >{typeof consulta.tratamiento === "string" ? consulta.tratamiento : ""}</textarea>
                <p class="mt-1 text-xs text-[#200934]/60">Se usarán estos textos solo si no se agregan tratamientos estructurados.</p>
              </div>
            </div>

            <div class="rounded-2xl border border-[#200934]/10 bg-[#fdfcff] px-4 py-3">
              <p class="text-sm font-semibold text-[#200934]">Órdenes de examen</p>
              <p class="text-xs text-[#200934]/70">Selecciona desde el catálogo o escribe un examen y presiona agregar.</p>
              <div class="mt-3 flex flex-col gap-2 sm:flex-row">
                <input
                  id="ordenExamenes"
                  name="ordenExamenes"
                type="text"
                list="ordenes-examenes-list"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                placeholder="Ej: Hemograma, perfil lipídico"
                value={consulta.orden_examenes ?? ""}
                />
                <button
                  type="button"
                  class="rounded-2xl bg-[#321355] px-4 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
                  data-add-exam
                >
                  Agregar examen
                </button>
              </div>
              <datalist id="ordenes-examenes-list">
                {examenesDatalist.map((nombre) => (
                  <option value={nombre}></option>
                ))}
              </datalist>
              <div class="mt-3 flex flex-wrap gap-2" data-exams-selected></div>
              <div class="mt-3 rounded-2xl border border-dashed border-[#200934]/15 bg-white px-3 py-3">
                <p class="text-xs font-semibold text-[#200934]">Catálogo según especialidad</p>
                <div class="mt-2 flex flex-wrap gap-2" data-exams-catalog>
                  {examenesCatalogo.map((item) => (
                    <button
                      type="button"
                      class="rounded-full bg-[#f4f1fb] px-3 py-1 text-xs font-semibold text-[#200934] transition hover:bg-[#e8e0fb]"
                      data-exam-suggest={item.nombre_examen}
                      data-exam-specialty={item.especialidad?.nombre_especialidad ?? ""}
                    >
                      {item.nombre_examen}
                    </button>
                  ))}
                  {examenesCatalogo.length === 0 ? (
                    <span class="text-xs text-[#200934]/60">Sin exámenes configurados para esta especialidad.</span>
                  ) : null}
                </div>
              </div>
            </div>

            <div class="space-y-3">
              <button
                id="consulta-edit-submit"
                type="submit"
                class="w-full rounded-2xl bg-[#321355] px-6 py-3 text-sm font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
              >
                Guardar cambios
              </button>
              <p id="consulta-edit-status" class="min-h-[1.25rem] text-sm font-medium text-[#200934]" aria-live="polite"></p>
            </div>
          </form>
        </article>
      </div>
    </div>
  </section>
</Layout>

<script type="application/json" id="catalog-data" set:html={catalogData}></script>

<script type="module">
  const form = document.querySelector('#consulta-edit-form');
  const statusField = document.querySelector('#consulta-edit-status');
  const submitButton = document.querySelector('#consulta-edit-submit');
  const consultaIdInput = document.querySelector('#consultaId');
  const resumenInput = document.querySelector('#resumen');
  const derivacionInput = document.querySelector('#derivacion');
  const diagnosticoInput = document.querySelector('#diagnostico');
  const tratamientoMedicamentoInput = document.querySelector('#tratamientoMedicamento');
  const tratamientoFrecuenciaInput = document.querySelector('#tratamientoFrecuencia');
  const tratamientoDuracionInput = document.querySelector('#tratamientoDuracion');
  const tratamientoLibreInput = document.querySelector('#tratamientoLibre');
  const treatmentList = document.querySelector('[data-treatment-list]');
  const addTreatmentButton = document.querySelector('[data-add-treatment]');
  const ordenExamenesInput = document.querySelector('#ordenExamenes');
  const addExamButton = document.querySelector('[data-add-exam]');
  const selectedExamsContainer = document.querySelector('[data-exams-selected]');
  const examCatalogButtons = Array.from(document.querySelectorAll('[data-exam-suggest]'));
  const catalogDataEl = document.querySelector('#catalog-data');
  const initialExamString =
    ordenExamenesInput instanceof HTMLInputElement ? ordenExamenesInput.value : '';

  const setStatus = (message, isError = false) => {
    if (!statusField) return;
    statusField.textContent = message ?? '';
    statusField.classList.toggle('text-rose-600', Boolean(isError));
    statusField.classList.toggle('text-emerald-600', !isError);
  };

  const parseCatalogData = () => {
    try {
      return JSON.parse(catalogDataEl?.textContent ?? '{}');
    } catch (error) {
      console.error('No se pudo leer cat\u00e1logos de medicamentos/ex\u00e1menes', error);
      return {};
    }
  };

  const { tratamientos = [] } = parseCatalogData();

  const normalizeExam = (value) => value.trim().replace(/\s+/g, ' ');
  const parseExamList = (value) =>
    Array.from(new Set((value ?? '').split(',').map(normalizeExam).filter(Boolean)));

  let selectedExams = parseExamList(initialExamString);

  const parseTreatments = (items) => {
    if (!Array.isArray(items)) return [];
    return items
      .map((item) => ({
        medicamento: String(item?.medicamento ?? item?.nombre ?? '').trim(),
        frecuencia: String(item?.frecuencia ?? '').trim(),
        duracion: String(item?.duracion ?? '').trim(),
      }))
      .filter((item) => item.medicamento && item.frecuencia && item.duracion);
  };

  let treatments = parseTreatments(tratamientos);

  const renderSelectedExams = () => {
    if (ordenExamenesInput) {
      ordenExamenesInput.value = '';
    }
    if (!selectedExamsContainer) return;
    if (selectedExams.length === 0) {
      selectedExamsContainer.innerHTML =
        '<span class="text-xs text-[#200934]/60">Sin ex\u00e1menes seleccionados.</span>';
      return;
    }
    selectedExamsContainer.innerHTML = selectedExams
      .map(
        (exam) => `
          <span class="inline-flex items-center gap-2 rounded-full bg-[#f4f1fb] px-3 py-1 text-xs font-semibold text-[#200934]">
            <span>${exam}</span>
            <button
              type="button"
              class="text-[#200934]/60 transition hover:text-rose-600"
              data-remove-exam="${exam}"
              aria-label="Quitar examen ${exam}"
            >
              &times;
            </button>
          </span>
        `,
      )
      .join('');
  };

  const renderTreatments = () => {
    if (!treatmentList) return;
    if (treatments.length === 0) {
      treatmentList.innerHTML = '<li class="text-xs text-[#200934]/60">Sin tratamientos asignados.</li>';
      return;
    }
    treatmentList.innerHTML = treatments
      .map(
        (item, index) => `
        <li class="rounded-2xl border border-[#200934]/10 px-4 py-2 text-sm flex items-center justify-between gap-2">
          <div>
            <p class="font-semibold">${item.medicamento}</p>
            <p class="text-xs text-[#200934]/70">
              Frecuencia: ${item.frecuencia} \u00b7 Duraci\u00f3n: ${item.duracion}
            </p>
          </div>
          <button
            type="button"
            class="text-xs font-semibold text-rose-600"
            data-remove-treatment="${index}"
          >
            Quitar
          </button>
        </li>
      `,
      )
      .join('');
  };

  const addExam = (exam) => {
    const clean = normalizeExam(exam ?? '');
    if (!clean) return;
    const exists = selectedExams.some((item) => item.toLowerCase() === clean.toLowerCase());
    if (exists) return;
    selectedExams.push(clean);
    renderSelectedExams();
  };

  addExamButton?.addEventListener('click', () => {
    if (!(ordenExamenesInput instanceof HTMLInputElement)) return;
    addExam(ordenExamenesInput.value);
    ordenExamenesInput.value = '';
  });

  ordenExamenesInput?.addEventListener('keydown', (event) => {
    if (!(ordenExamenesInput instanceof HTMLInputElement)) return;
    if (event.key === 'Enter') {
      event.preventDefault();
      addExam(ordenExamenesInput.value);
      ordenExamenesInput.value = '';
    }
  });

  examCatalogButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const exam = btn.getAttribute('data-exam-suggest') ?? '';
      addExam(exam);
    });
  });

  selectedExamsContainer?.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const removeBtn = target.closest('[data-remove-exam]');
    if (!removeBtn) return;
    const exam = removeBtn.getAttribute('data-remove-exam') ?? '';
    selectedExams = selectedExams.filter((item) => item.toLowerCase() !== exam.toLowerCase());
    renderSelectedExams();
  });

  addTreatmentButton?.addEventListener('click', () => {
    const medicamento = tratamientoMedicamentoInput?.value.trim() ?? '';
    const frecuencia = tratamientoFrecuenciaInput?.value.trim() ?? '';
    const duracion = tratamientoDuracionInput?.value.trim() ?? '';

    if (!medicamento || !frecuencia || !duracion) {
      setStatus('Completa medicamento, frecuencia y duraci\u00f3n.', true);
      return;
    }

    treatments.push({ medicamento, frecuencia, duracion });
    setStatus('');
    renderTreatments();

    if (tratamientoMedicamentoInput) tratamientoMedicamentoInput.value = '';
    if (tratamientoFrecuenciaInput) tratamientoFrecuenciaInput.value = '';
    if (tratamientoDuracionInput) tratamientoDuracionInput.value = '';
  });

  treatmentList?.addEventListener('click', (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const index = target.dataset.removeTreatment;
    if (index === undefined) return;
    treatments.splice(Number(index), 1);
    renderTreatments();
  });

  renderSelectedExams();
  renderTreatments();

  form?.addEventListener('submit', async (event) => {
    event.preventDefault();
    setStatus('');

    const consultaId = Number(consultaIdInput?.value ?? '0');
    if (!Number.isInteger(consultaId) || consultaId <= 0) {
      setStatus('Consulta inv\u00e1lida.', true);
      return;
    }

    const resumen = resumenInput?.value.trim() ?? '';
    if (!resumen) {
      setStatus('El resumen no puede estar vac\u00edo.', true);
      return;
    }

    if (ordenExamenesInput instanceof HTMLInputElement && ordenExamenesInput.value.trim()) {
      addExam(ordenExamenesInput.value);
      ordenExamenesInput.value = '';
    }

    const tratamientoLibre = tratamientoLibreInput?.value.trim() ?? '';
    const payload = {
      consultaId,
      resumen,
      derivacion: derivacionInput?.value ?? '',
      diagnostico: diagnosticoInput?.value ?? '',
      tratamiento: treatments.length > 0 ? treatments : tratamientoLibre,
      ordenExamenes: selectedExams.join(', '),
    };

    submitButton && (submitButton.disabled = true);
    const originalText = submitButton?.textContent;
    if (submitButton) submitButton.textContent = 'Guardando...';

    try {
      const response = await fetch('/api/admin/consultas', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        setStatus(data.error ?? 'No pudimos actualizar la consulta.', true);
        return;
      }
      setStatus(data.message ?? 'Consulta actualizada.');
      setTimeout(() => {
        window.location.href = '/admin';
      }, 600);
    } catch (error) {
      console.error(error);
      setStatus('Error de conexi\u00f3n al guardar.', true);
    } finally {
      if (submitButton) submitButton.textContent = originalText ?? 'Guardar cambios';
      if (submitButton) submitButton.disabled = false;
    }
  });
</script>
