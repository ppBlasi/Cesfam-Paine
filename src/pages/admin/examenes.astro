---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

const examOrders = await prisma.examOrder.findMany({
  where: { resultado_url: { not: null } },
  orderBy: [{ updated_at: "desc" }],
  include: {
    paciente: {
      select: {
        rut_paciente: true,
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
      },
    },
    nurse: {
      select: {
        primer_nombre_trabajador: true,
        segundo_nombre_trabajador: true,
        apellido_p_trabajador: true,
        apellido_m_trabajador: true,
      },
    },
  },
});

const formatPatientName = (patient: (typeof examOrders)[number]["paciente"]) =>
  [
    patient?.primer_nombre_paciente,
    patient?.segundo_nombre_paciente,
    patient?.apellido_p_paciente,
    patient?.apellido_m_paciente,
  ]
    .filter(Boolean)
    .join(" ")
    .trim() || "Paciente sin nombre";

const formatWorkerName = (worker: (typeof examOrders)[number]["nurse"]) =>
  worker
    ? [
        worker.primer_nombre_trabajador,
        worker.segundo_nombre_trabajador,
        worker.apellido_p_trabajador,
        worker.apellido_m_trabajador,
      ]
        .filter(Boolean)
        .join(" ")
        .trim() || null
    : null;

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin fecha";
---

<Layout title="Exámenes cargados">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="flex flex-wrap items-center justify-between gap-4 text-white">
        <div>
          <p class="text-sm uppercase tracking-[0.35em] text-white/70">Equipo</p>
          <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Exámenes cargados</h1>
          <p class="mt-2 max-w-3xl text-white/80">
            Revisa los exámenes que tienen archivo cargado, con paciente, estado y enlace al resultado.
          </p>
        </div>
        <a
          href="/admin"
          class="inline-flex items-center rounded-2xl bg-white/10 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
        >
          Volver al panel
        </a>
      </header>

      <article class="rounded-3xl bg-white p-6 shadow-xl">
        {examOrders.length > 0 ? (
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#200934]/10 text-sm text-[#200934]/80">
              <thead class="bg-[#f9f7ff] text-[#200934]">
                <tr>
                  <th class="px-3 py-3 text-left font-semibold">ID</th>
                  <th class="px-3 py-3 text-left font-semibold">Examen</th>
                  <th class="px-3 py-3 text-left font-semibold">Paciente</th>
                  <th class="px-3 py-3 text-left font-semibold">RUT</th>
                  <th class="px-3 py-3 text-left font-semibold">Estado</th>
                  <th class="px-3 py-3 text-left font-semibold">Subido por</th>
                  <th class="px-3 py-3 text-left font-semibold">Última actualización</th>
                  <th class="px-3 py-3 text-left font-semibold">Resultado</th>
                  <th class="px-3 py-3 text-left font-semibold">Reemplazar</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-[#200934]/10">
                {examOrders.map((order) => (
                  <tr class="hover:bg-[#f9f7ff]">
                    <td class="px-3 py-3 font-semibold text-[#200934]">#{order.id.toString()}</td>
                    <td class="px-3 py-3">{order.nombre_examen}</td>
                    <td class="px-3 py-3">{formatPatientName(order.paciente)}</td>
                    <td class="px-3 py-3">{order.paciente?.rut_paciente ?? "Sin RUT"}</td>
                    <td class="px-3 py-3">{order.estado ?? "Sin estado"}</td>
                    <td class="px-3 py-3">{formatWorkerName(order.nurse) ?? "Sin registro"}</td>
                    <td class="px-3 py-3">{formatDateTime(order.updated_at)}</td>
                    <td class="px-3 py-3">
                      {order.resultado_url ? (
                        <a
                          href={order.resultado_url}
                          class="inline-flex items-center rounded-2xl bg-[#321355] px-3 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
                          target="_blank"
                          rel="noreferrer"
                        >
                          Ver archivo
                        </a>
                      ) : (
                        <span class="text-xs text-amber-700">Sin archivo</span>
                      )}
                    </td>
                    <td class="px-3 py-3">
                      <form
                        method="post"
                        action="/api/admin/examenes/reemplazar"
                        enctype="multipart/form-data"
                        class="flex items-center gap-2"
                        data-replace-form
                        data-order-id={order.id.toString()}
                      >
                        <input type="hidden" name="examOrderId" value={order.id.toString()} />
                        <input
                          type="file"
                          name="file"
                          accept=".pdf,image/*"
                          class="text-xs text-[#200934]"
                          required
                        />
                        <button
                          type="submit"
                          class="inline-flex items-center rounded-2xl bg-[#321355] px-3 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
                        >
                          Reemplazar
                        </button>
                      </form>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <p class="rounded-2xl border border-dashed border-[#200934]/20 bg-[#faf7ff] px-4 py-6 text-sm text-[#200934]/70">
            No hay exámenes cargados aún.
          </p>
        )}
      </article>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const forms = Array.from(document.querySelectorAll("[data-replace-form]"));
      forms.forEach((form) => {
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!(form instanceof HTMLFormElement)) return;
          const submitBtn = form.querySelector("button[type='submit']");
          try {
            submitBtn?.setAttribute("disabled", "true");
            if (submitBtn instanceof HTMLButtonElement) {
              submitBtn.textContent = "Subiendo...";
            }
            const formData = new FormData(form);
            const response = await fetch(form.action, {
              method: form.method || "POST",
              body: formData,
              headers: { Accept: "application/json" },
            });
            const result = await response.json().catch(() => null);
            if (!response.ok || !result) {
              throw new Error(result?.error ?? "No pudimos reemplazar el examen.");
            }
            window.location.reload();
          } catch (error) {
            alert(error instanceof Error ? error.message : "No pudimos reemplazar el examen.");
          } finally {
            if (submitBtn instanceof HTMLButtonElement) {
              submitBtn.removeAttribute("disabled");
              submitBtn.textContent = "Reemplazar";
            }
          }
        });
      });
    });
  </script>
</Layout>
