---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user?.isAdmin) {
  return Astro.redirect("/");
}

const [especialidades, trabajadores] = await Promise.all([
  prisma.especialidad.findMany({
    orderBy: { nombre_especialidad: "asc" },
  }),
  prisma.trabajador.findMany({
    orderBy: [
      { estado_trabajador: "asc" },
      { apellido_p_trabajador: "asc" },
      { apellido_m_trabajador: "asc" },
    ],
    include: {
      especialidad: {
        select: {
          id_especialidad: true,
          nombre_especialidad: true,
        },
      },
    },
  }),
]);

const formatWorkerName = (worker: (typeof trabajadores)[number]) =>
  `${worker.primer_nombre_trabajador}${
    worker.segundo_nombre_trabajador ? ` ${worker.segundo_nombre_trabajador}` : ""
  } ${worker.apellido_p_trabajador} ${worker.apellido_m_trabajador}`.trim();
---

<Layout title="Gestion de trabajadores">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-10 px-4 sm:px-6">
      <header class="text-white">
        <p class="text-sm uppercase tracking-[0.35em] text-white/60">Equipo</p>
        <h1 class="mt-3 text-3xl font-bold sm:text-4xl">Administrar trabajadores</h1>
        <p class="mt-2 max-w-2xl text-white/80">
          Registra nuevos profesionales y gestiona sus accesos a la plataforma. Las credenciales iniciales se generan de forma automatica.
        </p>
      </header>

      <section class="grid gap-6 lg:grid-cols-2">
        <article class="rounded-3xl bg-white p-6 shadow-xl">
          <h2 class="text-xl font-semibold text-[#200934]">Nuevo trabajador</h2>
          <p class="mt-1 text-sm text-[#200934]/70">
            La contrasena inicial seguira el formato <strong>RUT + primer nombre en minusculas</strong>. Se recomienda informar al profesional y pedir cambio al iniciar sesion.
          </p>
          <form id="create-worker-form" class="mt-5 grid gap-4 md:grid-cols-2" autocomplete="off">
            <div class="md:col-span-2">
              <label for="rut" class="mb-2 block text-sm font-semibold text-[#200934]">RUT</label>
              <input
                id="rut"
                name="rut"
                type="text"
                required
                placeholder="12.345.678-9"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="primerNombre" class="mb-2 block text-sm font-semibold text-[#200934]">Primer nombre</label>
              <input
                id="primerNombre"
                name="primerNombre"
                type="text"
                required
                placeholder="Ana"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="segundoNombre" class="mb-2 block text-sm font-semibold text-[#200934]">Segundo nombre</label>
              <input
                id="segundoNombre"
                name="segundoNombre"
                type="text"
                placeholder="Opcional"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="apellidoPaterno" class="mb-2 block text-sm font-semibold text-[#200934]">Apellido paterno</label>
              <input
                id="apellidoPaterno"
                name="apellidoPaterno"
                type="text"
                required
                placeholder="Gonzalez"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="apellidoMaterno" class="mb-2 block text-sm font-semibold text-[#200934]">Apellido materno</label>
              <input
                id="apellidoMaterno"
                name="apellidoMaterno"
                type="text"
                required
                placeholder="MuÃ±oz"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="correo" class="mb-2 block text-sm font-semibold text-[#200934]">Correo</label>
              <input
                id="correo"
                name="correo"
                type="email"
                required
                placeholder="correo@ejemplo.cl"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="celular" class="mb-2 block text-sm font-semibold text-[#200934]">Celular</label>
              <input
                id="celular"
                name="celular"
                type="tel"
                required
                placeholder="+56 9 0000 0000"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div class="md:col-span-2">
              <label for="direccion" class="mb-2 block text-sm font-semibold text-[#200934]">Direccion</label>
              <input
                id="direccion"
                name="direccion"
                type="text"
                required
                placeholder="Calle 123, Ciudad"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div class="md:col-span-2">
              <label for="especialidadId" class="mb-2 block text-sm font-semibold text-[#200934]">Especialidad</label>
              <select
                id="especialidadId"
                name="especialidadId"
                required
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              >
                <option value="" selected disabled>Selecciona una especialidad</option>
                {especialidades.map((especialidad) => (
                  <option value={especialidad.id_especialidad}>{especialidad.nombre_especialidad}</option>
                ))}
              </select>
            </div>

            <div class="md:col-span-2 flex flex-col gap-3">
              <button
                id="create-worker-submit"
                type="submit"
                class="rounded-2xl bg-[#321355] px-6 py-3 text-sm font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355] disabled:opacity-60"
              >
                Registrar trabajador
              </button>
              <p
                id="create-worker-status"
                class="min-h-[1.25rem] text-sm font-medium text-[#200934]"
                aria-live="polite"
              ></p>
            </div>
          </form>
        </article>

        <article class="rounded-3xl bg-white p-6 shadow-xl">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-semibold text-[#200934]">Listado actualizado</h2>
              <p class="mt-1 text-sm text-[#200934]/70">
                Administra el acceso del equipo aplicando filtros por nombre, rut o especialidad.
              </p>
            </div>
            <span
              id="worker-results-label"
              class="rounded-full bg-[#f4efff] px-4 py-1 text-sm font-semibold text-[#200934]"
            >
              {trabajadores.length} {trabajadores.length === 1 ? "trabajador" : "trabajadores"}
            </span>
          </div>

          {trabajadores.length > 0 ? (
            <>
              <div class="mt-6 grid gap-4 lg:grid-cols-3">
                <div>
                  <label for="filter-name" class="mb-2 block text-sm font-semibold text-[#200934]">
                    Nombre
                  </label>
                  <input
                    id="filter-name"
                    type="text"
                    placeholder="Busca por nombres o apellidos"
                    class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                  />
                </div>
                <div>
                  <label for="filter-rut" class="mb-2 block text-sm font-semibold text-[#200934]">
                    RUT
                  </label>
                  <input
                    id="filter-rut"
                    type="text"
                    placeholder="Ej: 12.345.678-9"
                    class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                  />
                </div>
                <div>
                  <label for="filter-specialty" class="mb-2 block text-sm font-semibold text-[#200934]">
                    Especialidad
                  </label>
                  <select
                    id="filter-specialty"
                    class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
                  >
                    <option value="all">Todas las especialidades</option>
                    <option value="none">Sin asignar</option>
                    {especialidades.map((especialidad) => (
                      <option value={especialidad.id_especialidad}>{especialidad.nombre_especialidad}</option>
                    ))}
                  </select>
                </div>
              </div>

              <div class="mt-3 flex flex-wrap gap-3">
                <button
                  id="worker-filters-reset"
                  type="button"
                  class="rounded-2xl border border-[#200934]/15 px-4 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/40 hover:bg-[#f7f4ff]"
                >
                  Limpiar filtros
                </button>
              </div>

              <p
                id="worker-action-status"
                class="mt-4 min-h-[1.25rem] text-sm font-medium text-[#200934]"
                aria-live="polite"
              ></p>

              <ul id="worker-list" class="mt-4 space-y-4">
                {trabajadores.map((trabajador) => (
                <li
                  class="rounded-2xl border border-[#200934]/10 p-4 text-sm text-[#200934]/80 shadow-sm transition hover:border-[#200934]/30"
                  data-worker-card
                  data-worker-id={trabajador.id_trabajador}
                  data-rut={trabajador.rut_trabajador}
                  data-name={formatWorkerName(trabajador)}
                  data-first-name={trabajador.primer_nombre_trabajador}
                  data-second-name={trabajador.segundo_nombre_trabajador ?? ""}
                  data-lastname-p={trabajador.apellido_p_trabajador}
                  data-lastname-m={trabajador.apellido_m_trabajador}
                  data-email={trabajador.correo_trabajador}
                  data-phone={trabajador.celular_trabajador}
                  data-address={trabajador.direccion_trabajador ?? ""}
                  data-specialty-id={trabajador.especialidad?.id_especialidad ?? "none"}
                  data-state={trabajador.estado_trabajador}
                >
                    <div class="flex flex-wrap items-center justify-between gap-2">
                      <p class="text-base font-semibold text-[#200934]">{formatWorkerName(trabajador)}</p>
                      <span
                        data-worker-state-label
                        class={`rounded-full px-3 py-1 text-xs font-semibold ${
                          trabajador.estado_trabajador === "Activo"
                            ? "bg-emerald-50 text-emerald-700"
                            : "bg-rose-50 text-rose-700"
                        }`}
                      >
                        {trabajador.estado_trabajador}
                      </span>
                    </div>
                    <p class="text-[#200934]/70">
                      RUT: <span class="font-medium text-[#200934]">{trabajador.rut_trabajador}</span>
                    </p>
                    <p class="text-[#200934]/70">
                      Especialidad:{" "}
                      <span class="font-medium text-[#200934]">
                        {trabajador.especialidad?.nombre_especialidad ?? "Sin asignar"}
                      </span>
                    </p>
                    <p class="text-[#200934]/70">
                      Contacto: <span class="font-medium text-[#200934]">{trabajador.correo_trabajador}</span> &middot;{" "}
                      <span class="font-medium text-[#200934]">{trabajador.celular_trabajador}</span>
                    </p>
                    <p class="text-[#200934]/70">
                      Direccion: <span class="font-medium text-[#200934]">{trabajador.direccion_trabajador}</span>
                    </p>
                    <div class="mt-4 flex flex-wrap gap-3">
                      <button
                        type="button"
                        class="rounded-2xl border border-[#200934]/20 px-4 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/40 hover:bg-[#f7f4ff] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
                        data-worker-action="edit"
                        data-worker-id={trabajador.id_trabajador}
                      >
                        Editar datos
                      </button>
                      <button
                        type="button"
                        class={`rounded-2xl px-4 py-2 text-sm font-semibold transition focus:outline-none focus:ring-2 focus:ring-offset-2 ${
                          trabajador.estado_trabajador === "Activo"
                            ? "bg-rose-600 text-white hover:bg-rose-700 focus:ring-rose-500"
                            : "bg-emerald-600 text-white hover:bg-emerald-700 focus:ring-emerald-500"
                        }`}
                        data-worker-action="toggle-state"
                        data-worker-id={trabajador.id_trabajador}
                        data-worker-state={trabajador.estado_trabajador}
                      >
                        {trabajador.estado_trabajador === "Activo" ? "Desactivar" : "Reactivar"}
                      </button>
                    </div>
                  </li>
                ))}
              </ul>

              <div
                id="worker-empty-state"
                class="mt-6 hidden rounded-2xl border border-dashed border-[#200934]/20 bg-[#faf7ff] px-4 py-6 text-center text-sm text-[#200934]/70"
              >
                No encontramos trabajadores que coincidan con los filtros seleccionados.
              </div>
            </>
          ) : (
            <div class="mt-6 rounded-2xl border border-dashed border-[#200934]/20 bg-[#faf7ff] px-4 py-6 text-center text-sm text-[#200934]/70">
              Aun no hay trabajadores registrados.
            </div>
          )}
        </article>
        <article class="rounded-3xl bg-white p-6 shadow-xl lg:col-span-2">
          <h2 class="text-xl font-semibold text-[#200934]">Actualizar trabajador</h2>
          <p class="mt-1 text-sm text-[#200934]/70">
            Selecciona el boton <strong>"Editar datos"</strong> en la lista para cargar la informacion en este formulario.
          </p>
          <form id="edit-worker-form" class="mt-5 grid gap-4 md:grid-cols-2" autocomplete="off">
            <input type="hidden" name="workerId" id="editWorkerId" />
            <div class="md:col-span-2">
              <p id="edit-worker-selected" class="text-sm font-semibold text-[#200934]">
                Ningun trabajador seleccionado.
              </p>
            </div>

            <div>
              <label for="editPrimerNombre" class="mb-2 block text-sm font-semibold text-[#200934]">
                Primer nombre
              </label>
              <input
                id="editPrimerNombre"
                name="primerNombre"
                type="text"
                placeholder="Primer nombre"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editSegundoNombre" class="mb-2 block text-sm font-semibold text-[#200934]">
                Segundo nombre
              </label>
              <input
                id="editSegundoNombre"
                name="segundoNombre"
                type="text"
                placeholder="Opcional"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editApellidoPaterno" class="mb-2 block text-sm font-semibold text-[#200934]">
                Apellido paterno
              </label>
              <input
                id="editApellidoPaterno"
                name="apellidoPaterno"
                type="text"
                placeholder="Apellido paterno"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editApellidoMaterno" class="mb-2 block text-sm font-semibold text-[#200934]">
                Apellido materno
              </label>
              <input
                id="editApellidoMaterno"
                name="apellidoMaterno"
                type="text"
                placeholder="Apellido materno"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editCorreo" class="mb-2 block text-sm font-semibold text-[#200934]">Correo</label>
              <input
                id="editCorreo"
                name="correo"
                type="email"
                placeholder="correo@ejemplo.cl"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editCelular" class="mb-2 block text-sm font-semibold text-[#200934]">Celular</label>
              <input
                id="editCelular"
                name="celular"
                type="tel"
                placeholder="+56 9 0000 0000"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div class="md:col-span-2">
              <label for="editDireccion" class="mb-2 block text-sm font-semibold text-[#200934]">Direccion</label>
              <input
                id="editDireccion"
                name="direccion"
                type="text"
                placeholder="Calle 123, Ciudad"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              />
            </div>

            <div>
              <label for="editEspecialidadId" class="mb-2 block text-sm font-semibold text-[#200934]">
                Especialidad
              </label>
              <select
                id="editEspecialidadId"
                name="especialidadId"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              >
                <option value="" disabled selected>Selecciona una especialidad</option>
                <option value="none">Sin asignar</option>
                {especialidades.map((especialidad) => (
                  <option value={especialidad.id_especialidad}>{especialidad.nombre_especialidad}</option>
                ))}
              </select>
            </div>

            <div>
              <label for="editEstado" class="mb-2 block text-sm font-semibold text-[#200934]">Estado</label>
              <select
                id="editEstado"
                name="estado"
                class="w-full rounded-2xl border border-[#200934]/15 px-4 py-3 text-sm text-[#200934] shadow-sm outline-none transition focus:border-[#200934] focus:ring-2 focus:ring-[#200934]/30"
              >
                <option value="" disabled selected>Selecciona estado</option>
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>

            <div class="md:col-span-2 space-y-3">
              <button
                id="edit-worker-submit"
                type="submit"
                class="w-full rounded-2xl bg-[#321355] px-6 py-3 text-sm font-semibold text-white transition hover:bg-[#200934] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
              >
                Guardar cambios
              </button>
              <p id="edit-worker-status" class="min-h-[1.25rem] text-sm font-medium text-[#200934]" aria-live="polite"></p>
            </div>
          </form>
        </article>
      </section>
    </div>
  </section>
</Layout>

<script type="module">
  /** @type {HTMLFormElement | null} */
  const form = document.querySelector('#create-worker-form');
  const statusField = document.querySelector('#create-worker-status');
  const submitButton = document.querySelector('#create-worker-submit');

  const toJSON = (formData) => {
    const payload = {};
    formData.forEach((value, key) => {
      payload[key] = typeof value === 'string' ? value.trim() : value;
    });
    return payload;
  };

  if (form && statusField && submitButton) {
    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      statusField.textContent = '';

      const payload = toJSON(new FormData(form));

      submitButton.disabled = true;
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Guardando...';

      try {
        const response = await fetch('/api/admin/trabajadores', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          statusField.textContent = data.error ?? 'No pudimos completar el registro.';
          statusField.classList.remove('text-emerald-600');
          statusField.classList.add('text-rose-600');
          return;
        }

        statusField.textContent = `Trabajador creado. Contrasena inicial: ${data.initialPassword}`;
        statusField.classList.remove('text-rose-600');
        statusField.classList.add('text-emerald-600');
        form.reset();
        setTimeout(() => window.location.reload(), 1200);
      } catch (error) {
        console.error(error);
        statusField.textContent = 'Error de conexion. Intenta nuevamente.';
        statusField.classList.remove('text-emerald-600');
        statusField.classList.add('text-rose-600');
      } finally {
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    });
  }

  const editForm = document.querySelector('#edit-worker-form');
  const editStatusField = document.querySelector('#edit-worker-status');
  const editSubmitButton = document.querySelector('#edit-worker-submit');
  const editWorkerIdInput = document.querySelector('#editWorkerId');
  const editSelectedLabel = document.querySelector('#edit-worker-selected');
  const editInputs = {
    primerNombre: document.querySelector('#editPrimerNombre'),
    segundoNombre: document.querySelector('#editSegundoNombre'),
    apellidoPaterno: document.querySelector('#editApellidoPaterno'),
    apellidoMaterno: document.querySelector('#editApellidoMaterno'),
    correo: document.querySelector('#editCorreo'),
    celular: document.querySelector('#editCelular'),
    direccion: document.querySelector('#editDireccion'),
  };
  const editSpecialtySelect = document.querySelector('#editEspecialidadId');
  const editEstadoSelect = document.querySelector('#editEstado');

  const filterName = document.querySelector('#filter-name');
  const filterRut = document.querySelector('#filter-rut');
  const filterSpecialty = document.querySelector('#filter-specialty');
  const resetFiltersButton = document.querySelector('#worker-filters-reset');
  const workerList = document.querySelector('#worker-list');
  const workerResultsLabel = document.querySelector('#worker-results-label');
  const workerEmptyState = document.querySelector('#worker-empty-state');
  const workerActionStatus = document.querySelector('#worker-action-status');

  const normalizeText = (value = '') =>
    value
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');

  const normalizeRut = (value = '') =>
    normalizeText(value).replace(/[^0-9k]/g, '');

  const setActionStatus = (message, isError = false) => {
    if (!workerActionStatus) {
      return;
    }

    workerActionStatus.textContent = message ?? '';
    workerActionStatus.classList.toggle('text-rose-600', Boolean(isError));
    workerActionStatus.classList.toggle('text-emerald-600', !isError);
  };

  const setEditStatus = (message, isError = false) => {
    if (!editStatusField) {
      return;
    }

    editStatusField.textContent = message ?? '';
    editStatusField.classList.toggle('text-rose-600', Boolean(isError));
    editStatusField.classList.toggle('text-emerald-600', !isError);
  };

  const setEditSelectedText = (text) => {
    if (editSelectedLabel) {
      editSelectedLabel.textContent = text;
    }
  };

  const fillEditFormFromCard = (card) => {
    if (!editForm || !editWorkerIdInput) {
      return;
    }

    const workerId = Number(card.getAttribute('data-worker-id') ?? '0');
    if (!Number.isInteger(workerId) || workerId <= 0) {
      setEditStatus('No pudimos cargar al trabajador seleccionado.', true);
      return;
    }

    editWorkerIdInput.value = String(workerId);

    if (editInputs.primerNombre) {
      editInputs.primerNombre.value = card.getAttribute('data-first-name') ?? '';
    }
    if (editInputs.segundoNombre) {
      editInputs.segundoNombre.value = card.getAttribute('data-second-name') ?? '';
    }
    if (editInputs.apellidoPaterno) {
      editInputs.apellidoPaterno.value = card.getAttribute('data-lastname-p') ?? '';
    }
    if (editInputs.apellidoMaterno) {
      editInputs.apellidoMaterno.value = card.getAttribute('data-lastname-m') ?? '';
    }
    if (editInputs.correo) {
      editInputs.correo.value = card.getAttribute('data-email') ?? '';
    }
    if (editInputs.celular) {
      editInputs.celular.value = card.getAttribute('data-phone') ?? '';
    }
    if (editInputs.direccion) {
      editInputs.direccion.value = card.getAttribute('data-address') ?? '';
    }

    if (editSpecialtySelect) {
      const specialtyValue = card.getAttribute('data-specialty-id') ?? '';
      const normalized = specialtyValue === 'none' ? 'none' : specialtyValue;
      editSpecialtySelect.value = normalized || '';
    }

    if (editEstadoSelect) {
      editEstadoSelect.value = card.getAttribute('data-state') ?? '';
    }

    setEditSelectedText(`Editando: ${card.getAttribute('data-name') ?? ''}`);
    setEditStatus('');
    editForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  if (editForm && editSubmitButton && editWorkerIdInput) {
    editForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      setEditStatus('');

      const workerId = Number(editWorkerIdInput.value ?? '0');
      if (!Number.isInteger(workerId) || workerId <= 0) {
        setEditStatus('Selecciona un trabajador desde la lista antes de guardar.', true);
        return;
      }

      const getValue = (input) => (input ? input.value.trim() : '');
      const payload = {
        trabajadorId: workerId,
        primerNombre: getValue(editInputs.primerNombre),
        segundoNombre: getValue(editInputs.segundoNombre),
        apellidoPaterno: getValue(editInputs.apellidoPaterno),
        apellidoMaterno: getValue(editInputs.apellidoMaterno),
        correo: getValue(editInputs.correo),
        celular: getValue(editInputs.celular),
        direccion: getValue(editInputs.direccion),
        estado: editEstadoSelect?.value ?? '',
        especialidadId: editSpecialtySelect?.value ?? '',
      };

      const requiredFields = [
        ['primerNombre', payload.primerNombre],
        ['apellidoPaterno', payload.apellidoPaterno],
        ['apellidoMaterno', payload.apellidoMaterno],
        ['correo', payload.correo],
        ['celular', payload.celular],
        ['direccion', payload.direccion],
        ['estado', payload.estado],
      ];

      const missingField = requiredFields.find(([, value]) => !value);
      if (missingField) {
        setEditStatus('Completa todos los campos obligatorios para actualizar.', true);
        return;
      }

      editSubmitButton.disabled = true;
      const originalText = editSubmitButton.textContent;
      editSubmitButton.textContent = 'Guardando...';

      try {
        const response = await fetch('/api/admin/trabajadores', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          setEditStatus(data.error ?? 'No pudimos actualizar los datos.', true);
          return;
        }

        setEditStatus(data.message ?? 'Trabajador actualizado.');
        setTimeout(() => window.location.reload(), 1200);
      } catch (error) {
        console.error(error);
        setEditStatus('Error de conexion. Intenta nuevamente.', true);
      } finally {
        editSubmitButton.textContent = originalText;
        editSubmitButton.disabled = false;
      }
    });
  }


  const applyFilters = () => {
    if (!workerList) {
      return;
    }

    const rutQuery = normalizeRut(filterRut?.value ?? '');
    const nameQuery = normalizeText(filterName?.value ?? '');
    const specialtyQuery = filterSpecialty?.value ?? 'all';
    let visibleCount = 0;

    workerList.querySelectorAll('[data-worker-card]').forEach((card) => {
      const element = card;
      const cardRut = normalizeRut(element.getAttribute('data-rut') ?? '');
      const cardName = normalizeText(element.getAttribute('data-name') ?? '');
      const cardSpecialty = element.getAttribute('data-specialty-id') ?? 'none';

      const matchesRut = !rutQuery || cardRut.includes(rutQuery);
      const matchesName = !nameQuery || cardName.includes(nameQuery);
      const matchesSpecialty =
        specialtyQuery === 'all' ||
        (specialtyQuery === 'none' && cardSpecialty === 'none') ||
        cardSpecialty === specialtyQuery;

      const matches = matchesRut && matchesName && matchesSpecialty;
      element.classList.toggle('hidden', !matches);
      if (matches) {
        visibleCount += 1;
      }
    });

    if (workerResultsLabel) {
      workerResultsLabel.textContent = `${visibleCount} ${
        visibleCount === 1 ? 'trabajador' : 'trabajadores'
      }`;
    }

    if (workerEmptyState) {
      workerEmptyState.classList.toggle('hidden', visibleCount !== 0);
    }
  };

  if (workerList) {
    [filterName, filterRut].forEach((input) => {
      input?.addEventListener('input', () => {
        window.requestAnimationFrame(applyFilters);
      });
    });

    filterSpecialty?.addEventListener('change', applyFilters);

    resetFiltersButton?.addEventListener('click', () => {
      if (filterName) filterName.value = '';
      if (filterRut) filterRut.value = '';
      if (filterSpecialty) filterSpecialty.value = 'all';
      applyFilters();
    });

    applyFilters();

    workerList.addEventListener('click', async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const button = target.closest('button[data-worker-action]');
      if (!button) {
        return;
      }

      const action = button.dataset.workerAction;

      if (action === 'edit') {
        const card = button.closest('[data-worker-card]');
        if (!card) {
          return;
        }
        fillEditFormFromCard(card);
        return;
      }

      if (action !== 'toggle-state') {
        return;
      }

      const workerId = Number(button.dataset.workerId ?? '0');
      if (!Number.isInteger(workerId) || workerId <= 0) {
        return;
      }

      const currentState = button.dataset.workerState === 'Inactivo' ? 'Inactivo' : 'Activo';
      const nextState = currentState === 'Activo' ? 'Inactivo' : 'Activo';
      const confirmationMessage =
        nextState === 'Inactivo'
          ? 'Deseas desactivar el acceso de este trabajador?'
          : 'Deseas reactivar el acceso de este trabajador?';

      if (!window.confirm(confirmationMessage)) {
        return;
      }

      button.disabled = true;
      setActionStatus('Actualizando estado...');

      try {
        const response = await fetch('/api/admin/trabajadores', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trabajadorId: workerId, estado: nextState }),
        });

        const data = await response.json().catch(() => ({}));

        if (!response.ok) {
          setActionStatus(data.error ?? 'No pudimos actualizar el estado.', true);
          return;
        }

        const card = button.closest('[data-worker-card]');
        if (card) {
          card.setAttribute('data-state', nextState);
        }

        const stateLabel = card?.querySelector('[data-worker-state-label]');
        if (stateLabel) {
          stateLabel.textContent = nextState;
          stateLabel.classList.toggle('bg-emerald-50', nextState === 'Activo');
          stateLabel.classList.toggle('text-emerald-700', nextState === 'Activo');
          stateLabel.classList.toggle('bg-rose-50', nextState === 'Inactivo');
          stateLabel.classList.toggle('text-rose-700', nextState === 'Inactivo');
        }

        button.dataset.workerState = nextState;
        button.textContent = nextState === 'Activo' ? 'Desactivar' : 'Reactivar';
        button.classList.remove(
          'bg-rose-600',
          'hover:bg-rose-700',
          'focus:ring-rose-500',
          'bg-emerald-600',
          'hover:bg-emerald-700',
          'focus:ring-emerald-500'
        );
        if (nextState === 'Activo') {
          button.classList.add('bg-rose-600', 'hover:bg-rose-700', 'focus:ring-rose-500');
        } else {
          button.classList.add('bg-emerald-600', 'hover:bg-emerald-700', 'focus:ring-emerald-500');
        }

        setActionStatus(data.message ?? 'Estado actualizado.');
      } catch (error) {
        console.error(error);
        setActionStatus('Error de conexion al actualizar el estado.', true);
      } finally {
        button.disabled = false;
      }
    });
  }
</script>
