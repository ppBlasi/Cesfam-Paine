---
import Layout from "../layouts/Layout.astro";
import { prisma } from "../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

const patient = await prisma.paciente.findFirst({
  where: { rut_paciente: user.rut },
  select: {
    id_paciente: true,
    primer_nombre_paciente: true,
    segundo_nombre_paciente: true,
    apellido_p_paciente: true,
    apellido_m_paciente: true,
    celular_paciente: true,
    correo_paciente: true,
  },
});

const legacyReservations = patient
  ? await prisma.reserva.findMany({
      where: { paciente: { some: { id_paciente: patient.id_paciente } } },
      include: {
        estado: true,
        fecha_hora: true,
      },
      orderBy: { fecha_reserva: "desc" },
      take: 5,
    })
  : [];

const slotReservations = patient
  ? await prisma.disponibilidadTrabajador.findMany({
      where: { id_paciente: patient.id_paciente },
      include: {
        trabajador: {
          select: {
            primer_nombre_trabajador: true,
            segundo_nombre_trabajador: true,
            apellido_p_trabajador: true,
            apellido_m_trabajador: true,
            especialidad: { select: { nombre_especialidad: true } },
          },
        },
      },
      orderBy: { fecha: "desc" },
      take: 5,
    })
  : [];

const reservations = slotReservations
  .filter((slot) => slot.estado === "reservado" && slot.fecha > new Date())
  .map((slot) => {
    const isFuture = slot.fecha > new Date();
    const isCancelable = slot.estado === "reservado" && isFuture;
    return {
      id: `slot-${slot.id_disponibilidad}`,
      dateLabel: slot.fecha.toLocaleDateString("es-CL", { dateStyle: "medium" }),
      statusLabel: slot.estado.charAt(0).toUpperCase() + slot.estado.slice(1),
      datetime: slot.fecha,
      doctorName: [
        slot.trabajador.primer_nombre_trabajador,
        slot.trabajador.segundo_nombre_trabajador,
        slot.trabajador.apellido_p_trabajador,
        slot.trabajador.apellido_m_trabajador,
      ]
        .filter(Boolean)
        .join(" "),
      specialty: slot.trabajador.especialidad?.nombre_especialidad ?? "Medicina General",
      availabilityId: slot.id_disponibilidad,
      cancelable: isCancelable,
    };
  })
  .sort((a, b) => {
    const dateA = a.datetime ? new Date(a.datetime).getTime() : 0;
    const dateB = b.datetime ? new Date(b.datetime).getTime() : 0;
    return dateB - dateA;
  })
  .slice(0, 5);

const examOrders = patient
  ? await prisma.examOrder.findMany({
      where: { paciente_id: patient.id_paciente, estado: { in: ["PENDIENTE", "AGENDADO"] } },
      orderBy: [{ created_at: "desc" }],
    })
  : [];

const fullName = patient
  ? [
      patient.primer_nombre_paciente,
      patient.segundo_nombre_paciente,
      patient.apellido_p_paciente,
      patient.apellido_m_paciente,
    ]
      .filter(Boolean)
      .join(" ")
  : null;

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin asignar";

const cargoLabel =
  user.worker?.cargo === "ADMIN"
    ? "Administrador"
    : user.worker?.cargo === "RECEPCION"
      ? "Recepcion"
      : user.worker?.cargo === "MEDICO"
        ? "Medico"
        : user.worker?.cargo === "TENS"
          ? "TENS"
          : null;
---
<Layout title="Mi perfil">
  <section class="bg-[#f4f1fb] py-10">
    <div class="mx-auto flex w-full max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Mi cesfam</p>
        <h1 class="mt-3 text-3xl font-bold">Perfil de usuario</h1>
        <p class="mt-2 text-white/80">Rut asociado: <span class="font-semibold text-white">{user.rut}</span></p>
        {fullName ? (
          <p class="mt-1 text-white/80">Nombre completo: <span class="font-semibold text-white">{fullName}</span></p>
        ) : (
          <p class="mt-1 text-white/70">
            No encontramos datos personales asociados. Completa tu información en el centro de atención.
          </p>
        )}
        {cargoLabel ? (
          <p class="mt-1 text-white/80">
            Cargo: <span class="font-semibold text-white">{cargoLabel}</span>
            {user.worker?.cargo === "MEDICO" && (
              <>
                {" "}
                · Especialidad:{" "}
                <span class="font-semibold text-white">
                  {user.worker?.specialtyName ?? "Sin asignar"}
                </span>
              </>
            )}
          </p>
        ) : null}
      </header>

      <div class="grid gap-6 md:grid-cols-5">
        <article class="order-2 rounded-3xl bg-white p-6 shadow-lg md:order-1 md:col-span-3">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h2 class="text-xl font-semibold text-[#200934]">Horas reservadas</h2>
              <p class="text-xs text-[#200934]/60">Estas son tus próximas horas. El historial completo está en la otra página.</p>
            </div>
            <a
              href="/perfil/reservas"
              class="inline-flex items-center rounded-2xl bg-[#200934] px-4 py-2 text-xs font-semibold text-white transition hover:bg-[#321355] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
            >
              Ver historial de reservas
            </a>
          </div>
          <p id="reservations-status" class="mt-2 min-h-[1.25rem] text-sm font-medium text-[#200934]" aria-live="polite"></p>
          {reservations.length > 0 ? (
            <ul class="mt-4 space-y-4">
              {reservations.map((reservation) => (
                <li class="rounded-2xl bg-[#f9f7ff] p-4">
                  <p class="text-sm font-semibold text-[#200934]">{reservation.dateLabel}</p>
                  <p class="text-sm text-[#200934]/70">
                    Estado: <span class="font-medium text-[#200934]">{reservation.statusLabel}</span>
                  </p>
                  <p class="text-sm text-[#200934]/70">
                    Fecha y hora:{" "}
                    <span class="font-medium text-[#200934]">
                      {reservation.datetime ? formatDateTime(reservation.datetime) : reservation.dateLabel}
                    </span>
                  </p>
                  {reservation.doctorName ? (
                    <p class="text-sm text-[#200934]/70">
                      Profesional:{" "}
                      <span class="font-medium text-[#200934]">
                        {reservation.doctorName} ({reservation.specialty})
                      </span>
                    </p>
                  ) : null}
                  {reservation.cancelable ? (
                    <div class="mt-3 space-y-2" data-cancel-block>
                      <a
                        href={`/reserva/editar?availabilityId=${reservation.availabilityId}&specialty=${encodeURIComponent(reservation.specialty ?? "")}`}
                        class="inline-flex items-center rounded-2xl border border-[#200934]/20 px-4 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/40 hover:bg-[#f7f4ff] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
                      >
                        Editar
                      </a>
                      <button
                        type="button"
                        class="rounded-2xl border border-[#200934]/20 px-4 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/40 hover:bg-[#f7f4ff] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
                        data-cancel-reservation
                        data-availability-id={reservation.availabilityId}
                      >
                        Eliminar reserva
                      </button>
                      <div class="hidden items-center gap-2" data-cancel-confirm>
                        <span class="text-sm text-[#200934]">¿Eliminar reserva?</span>
                        <button
                          type="button"
                          class="rounded-2xl bg-rose-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-rose-500"
                          data-confirm-yes
                        >
                          Si
                        </button>
                        <button
                          type="button"
                          class="rounded-2xl bg-[#f7f4ff] px-3 py-1 text-xs font-semibold text-[#200934] transition hover:bg-[#ece3ff] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#321355]"
                          data-confirm-no
                        >
                          No
                        </button>
                      </div>
                    </div>
                  ) : null}
                </li>
              ))}
            </ul>
          ) : (
            <p class="mt-4 rounded-2xl bg-[#f9f7ff] p-4 text-sm text-[#200934]">
              No cuenta con hora reservada.
            </p>
          )}

          {examOrders.length > 0 ? (
            <div class="mt-6 rounded-3xl border border-[#200934]/10 bg-white p-5 shadow-inner">
              <div class="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <p class="text-sm font-semibold text-[#200934]">Exámenes pendientes</p>
                  <p class="text-xs text-[#200934]/70">
                    Tienes exámenes solicitados. Agenda con enfermería para coordinarlos.
                  </p>
                </div>
                <a
                  href="/perfil/reservas"
                  class="inline-flex items-center rounded-2xl bg-[#321355] px-4 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
                >
                  Agendar examen
                </a>
              </div>
              <ul class="mt-3 space-y-2 text-sm text-[#200934]/80">
                {examOrders.map((order) => (
                  <li class="rounded-2xl bg-[#f8f6ff] px-3 py-2">
                    <p class="font-semibold text-[#200934]">{order.nombre_examen}</p>
                    <p class="text-xs text-[#200934]/60">
                      Estado: {order.estado} ・ Solicitado:{" "}
                      {order.created_at
                        ? new Date(order.created_at).toLocaleDateString("es-CL", { dateStyle: "medium" })
                        : "Sin fecha"}
                    </p>
                  </li>
                ))}
              </ul>
            </div>
          ) : null}
        </article>

        <aside class="order-1 flex flex-col gap-4 rounded-3xl bg-white p-6 shadow-lg md:order-2 md:col-span-2">
          <h2 class="text-xl font-semibold text-[#200934]">Contacto</h2>
          <dl class="mt-2 space-y-3 text-sm text-[#200934]/80">
            <div>
              <dt class="font-semibold text-[#200934]">Correo</dt>
              <dd>{patient?.correo_paciente ?? 'Sin información'}</dd>
            </div>
            <div>
            <dt class="font-semibold text-[#200934]">Telefono</dt>
            <dd>{patient?.celular_paciente ?? 'Sin información'}</dd>
          </div>
        </dl>

          <div class="mt-4 space-y-3">
            <a
              href="/reserva/reserva"
              class="inline-flex w-full items-center justify-center rounded-2xl bg-[#200934] px-5 py-3 text-sm font-semibold text-white transition hover:bg-[#321355]"
            >
              Ir a reservar una hora
            </a>
            <a
              href="/perfil/consultas"
              class="inline-flex w-full items-center justify-center rounded-2xl border border-[#200934]/15 px-5 py-3 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/30 hover:bg-[#f7f4ff]"
            >
              Ver consultas
            </a>
          </div>
        </aside>
      </div>
    </div>
  </section>
</Layout>

<script type="module">
  const statusField = document.querySelector('#reservations-status');

  const setStatus = (message, isError = false) => {
    if (!statusField) return;
    statusField.textContent = message ?? '';
    statusField.classList.toggle('text-rose-600', Boolean(isError));
    statusField.classList.toggle('text-emerald-600', !isError);
  };

  const handleCancel = async (availabilityId) => {
    if (!availabilityId) return;

    setStatus('Eliminando reserva...');
    try {
      const response = await fetch('/api/reservas', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ disponibilidadId: availabilityId }),
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        setStatus(data.error ?? 'No pudimos eliminar la reserva.', true);
        return;
      }

      setStatus(data.message ?? 'Reserva eliminada.');
      setTimeout(() => window.location.reload(), 1000);
    } catch (error) {
      console.error(error);
      setStatus('Error de conexión al eliminar la reserva.', true);
    }
  };

  document.querySelectorAll('[data-cancel-block]').forEach((block) => {
    const trigger = block.querySelector('[data-cancel-reservation]');
    const confirmPanel = block.querySelector('[data-cancel-confirm]');
    const yesBtn = block.querySelector('[data-confirm-yes]');
    const noBtn = block.querySelector('[data-confirm-no]');

    if (!trigger || !confirmPanel || !yesBtn || !noBtn) return;

    const availabilityId = Number(trigger.getAttribute('data-availability-id') ?? '0');
    if (!Number.isInteger(availabilityId) || availabilityId <= 0) return;

    trigger.addEventListener('click', () => {
      trigger.classList.add('hidden');
      confirmPanel.classList.remove('hidden');
      confirmPanel.classList.add('flex');
    });

    noBtn.addEventListener('click', () => {
      confirmPanel.classList.add('hidden');
      confirmPanel.classList.remove('flex');
      trigger.classList.remove('hidden');
    });

    yesBtn.addEventListener('click', () => {
      trigger.disabled = true;
      yesBtn.disabled = true;
      noBtn.disabled = true;
      handleCancel(availabilityId);
    });
  });
</script>
