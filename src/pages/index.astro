---
import Layout from '../layouts/Layout.astro';

const user = Astro.locals.user;
const isTens = user?.worker?.cargo === 'TENS';
const isAdmin = user?.isAdmin || user?.worker?.cargo === 'ADMIN';
---

<Layout title="CESFAM">
  <section class="bg-gradient-to-b from-[#200934] via-[#2d1250] to-[#200934] py-16">
    <div class="mx-auto flex max-w-6xl flex-col gap-10 px-4 sm:px-6 text-white">

      <header class="text-center">
        <p class="text-sm uppercase tracking-widest text-white/70">
          Bienvenido al sistema del CESFAM Dr Miguel Solar de Paine
        </p>
        <h1 class="mt-3 text-4xl font-bold sm:text-5xl">Accede a tu portal de salud</h1>
        <p class="mt-4 max-w-2xl mx-auto text-white/80">
          Gestiona tus reservas, revisa información importante y mantente al día con las novedades del CESFAM.
        </p>

        {user ? (
          isAdmin ? (
            <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
              <a
                href="/trabajador"
                class="inline-block rounded-2xl bg-white/90 px-8 py-3 text-[#200934] font-semibold shadow-lg transition hover:bg-white"
              >
                Panel del trabajador
              </a>
              <a
                href="/admin"
                class="inline-block rounded-2xl border border-white/60 px-8 py-3 text-white font-semibold shadow-lg transition hover:bg-white/10"
              >
                Panel administrativo
              </a>
            </div>
          ) : isTens ? (
            <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
              <a
                href="/trabajador/preingreso"
                class="inline-block rounded-2xl bg-white/90 px-8 py-3 text-[#200934] font-semibold shadow-lg transition hover:bg-white"
              >
                Ir al preingreso
              </a>
              <a
                href="/trabajador"
                class="inline-block rounded-2xl border border-white/60 px-8 py-3 text-white font-semibold shadow-lg transition hover:bg-white/10"
              >
                Panel del trabajador
              </a>
            </div>
          ) : (
            <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
              <a
                href="/reserva/reserva"
                class="inline-block rounded-2xl bg-white/90 px-8 py-3 text-[#200934] font-semibold shadow-lg transition hover:bg-white"
              >
                Reserva tu hora
              </a>
              <a
                href="/perfil"
                class="inline-block rounded-2xl border border-white/60 px-8 py-3 text-white font-semibold shadow-lg transition hover:bg-white/10"
              >
                Ver perfil
              </a>
            </div>
          )
        ) : (
          <a
            href="/login"
            class="inline-block mt-6 rounded-2xl bg-white/90 px-8 py-3 text-[#200934] font-semibold shadow-lg transition hover:bg-white"
          >
            Inicia sesion aqui
          </a>
        )}
      </header>

      <section class="grid grid-cols-1 gap-6 md:grid-cols-2 mt-6">

        <article class="rounded-3xl bg-white/95 p-6 shadow-2xl backdrop-blur">
          <div class="bg-[#200934] text-white text-center py-2 rounded-xl font-semibold shadow-md">
            Campaña informativa
          </div>
          <img
            class="h-[9rem] w-full object-cover rounded-xl mt-4 shadow-md"
            src="/index/campana.webp"
            alt="campaña"
          />
        </article>

        <article class="rounded-3xl bg-white/95 p-6 shadow-2xl backdrop-blur">
          <div class="bg-[#200934] text-white text-center py-2 rounded-xl font-semibold shadow-md">
            Vacúnate a tiempo
          </div>
          <img
            class="h-[9rem] w-full object-cover rounded-xl mt-4 shadow-md"
            src="/index/vacunate.webp"
            alt="vacunate"
          />
        </article>

      </section>

      <!-- ============================
           CARRUSEL MEJORADO Y ARREGLADO
           ============================ -->
      <section class="rounded-3xl bg-white/95 shadow-2xl backdrop-blur p-4">
        <div class="relative overflow-hidden rounded-2xl">

          <div
            class="js-carousel relative w-full h-[17rem] sm:h-[24rem] md:h-[28rem] overflow-hidden select-none"
            role="region"
            aria-roledescription="carousel"
            aria-label="Carrusel de imágenes"
          >

            <!-- TRACK -->
            <div class="js-track flex h-full transition-transform duration-500 ease-out will-change-transform">

              <div class="w-full h-full shrink-0">
                <img
                  src="/index/hospital1.jpg"
                  class="w-full h-full object-cover object-center rounded-2xl shadow-lg"
                  alt="Hospital 1"
                />
              </div>

              <div class="w-full h-full shrink-0">
                <img
                  src="/index/hosp2.webp"
                  class="w-full h-full object-cover object-center rounded-2xl shadow-lg"
                  alt="Hospital 2"
                />
              </div>

              <div class="w-full h-full shrink-0">
                <img
                  src="/index/hops3.webp"
                  class="w-full h-full object-cover object-center rounded-2xl shadow-lg"
                  alt="Hospital 3"
                />
              </div>

            </div>

            <!-- NAVEGACIÓN: type="button" importante -->
            <button
              type="button"
              class="js-prev absolute left-3 top-1/2 -translate-y-1/2 z-10 bg-white/90 p-2 rounded-full shadow transition hover:scale-110"
              aria-label="Anterior"
            >
              <svg class="w-6 h-6 text-[#200934]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <button
              type="button"
              class="js-next absolute right-3 top-1/2 -translate-y-1/2 z-10 bg-white/90 p-2 rounded-full shadow transition hover:scale-110"
              aria-label="Siguiente"
            >
              <svg class="w-6 h-6 text-[#200934]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>

            <!-- DOTS -->
            <div class="js-dots absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2"></div>

          </div>
        </div>

        <!-- SCRIPT (mejorado y defensivo) -->
        <script type="module">
          (function () {
            const carousel = document.querySelector(".js-carousel");
            if (!carousel) return;

            const track = carousel.querySelector(".js-track");
            const slides = Array.from(track.children);
            const prevBtn = carousel.querySelector(".js-prev");
            const nextBtn = carousel.querySelector(".js-next");
            const dotsContainer = carousel.querySelector(".js-dots");

            if (!prevBtn || !nextBtn) {
              console.warn("Carrusel: no se encontraron los botones prev/next.");
            }

            let index = 0;
            let startX = 0;

            // Crear dots
            slides.forEach((_, i) => {
              const dot = document.createElement("button");
              dot.type = "button";
              dot.className = "w-3 h-3 rounded-full bg-white/40 transition";
              dot.setAttribute("aria-label", `Ir a la diapositiva ${i + 1}`);
              dot.addEventListener("click", () => {
                index = i;
                update();
              });
              dotsContainer.appendChild(dot);
            });

            function update() {
              // fuerza repaint seguro y usa transform GPU
              track.style.transform = `translateX(-${index * 100}%)`;

              // actualizar dots
              dotsContainer.querySelectorAll("button").forEach((dot, i) => {
                dot.classList.toggle("bg-white", i === index);
                dot.classList.toggle("bg-white/40", i !== index);
                dot.style.transform = i === index ? "scale(1.2)" : "scale(1)";
              });
            }

            // Manejo seguro de clicks en botones (incluye clicks sobre SVG)
            if (nextBtn) {
              nextBtn.addEventListener("click", (ev) => {
                ev.preventDefault();
                // fallback: si por alguna razón nextBtn no es el correcto, busca de nuevo
                if (!nextBtn) return;
                index = (index + 1) % slides.length;
                update();
              });
            }

            if (prevBtn) {
              prevBtn.addEventListener("click", (ev) => {
                ev.preventDefault();
                index = (index - 1 + slides.length) % slides.length;
                update();
              });
            }

            // Touch swipe
            track.addEventListener("touchstart", (e) => {
              startX = e.touches[0].clientX;
            }, { passive: true });

            track.addEventListener("touchend", (e) => {
              const dx = e.changedTouches[0].clientX - startX;
              if (dx > 50) index = (index - 1 + slides.length) % slides.length;
              if (dx < -50) index = (index + 1) % slides.length;
              update();
            });

            // Teclado (opcional)
            carousel.addEventListener("keydown", (e) => {
              if (e.key === "ArrowLeft") {
                index = (index - 1 + slides.length) % slides.length;
                update();
              } else if (e.key === "ArrowRight") {
                index = (index + 1) % slides.length;
                update();
              }
            });

            // Inicializar
            update();

            // --- Debug helpers (descomenta si quieres ver en consola) ---
            // console.log('slides', slides.length, { prevBtn, nextBtn });
          })();
        </script>
      </section>
      <!-- FIN CARRUSEL -->

      <section class="grid grid-cols-1 gap-6 md:grid-cols-2">

        <article class="rounded-3xl bg-white/95 shadow-2xl backdrop-blur p-6">
          <a href="/noticia">
            <div class="bg-[#200934] text-white text-center py-2 rounded-xl font-semibold shadow-md cursor-pointer">
              Noticias
            </div>
          </a>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
            <img
              class="h-[9rem] w-full object-cover rounded-xl shadow-md cursor-pointer js-zoom-img"
              src="/noticias/sm.jpg"
              alt="Noticia 1"
            />
            <img
              class="h-[9rem] w-full object-cover rounded-xl shadow-md cursor-pointer js-zoom-img"
              src="/noticias/ds.jpg"
              alt="Noticia 2"
            />
            <img
              class="h-[9rem] w-full object-cover rounded-xl shadow-md cursor-pointer js-zoom-img"
              src="/noticias/ginem.jpg"
              alt="Noticia 3"
            />
          </div>
        </article>

        <article class="rounded-3xl bg-white/95 shadow-2xl backdrop-blur p-6">
          <a href="/vidasana">
            <div class="bg-[#200934] text-white text-center py-2 rounded-xl font-semibold shadow-md cursor-pointer">
              Vida Sana
            </div>
          </a>

          <div class="flex justify-center mt-4">
            <img
              class="h-[11rem] w-[22rem] max-w-full object-cover rounded-xl shadow-md cursor-pointer js-zoom-img"
              src="/noticias/sal.jpg"
              alt="alimentación"
            />
          </div>
        </article>

      </section>

      <!-- MODAL ZOOM -->
      <div id="zoomModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden p-4">
        <img id="zoomImg" class="max-w-full max-h-full rounded-xl shadow-2xl" src="" alt="zoom" />
      </div>

      <script>
        const zoomModal = document.getElementById('zoomModal');
        const zoomImg = document.getElementById('zoomImg') as HTMLImageElement | null;

        if (zoomModal && zoomImg) {
          document.querySelectorAll<HTMLImageElement>('.js-zoom-img').forEach((el) => {
            el.addEventListener('click', () => {
              zoomImg.src = el.src;
              zoomModal.classList.remove('hidden');
              zoomModal.classList.add('flex', 'items-center', 'justify-center');
            });
          });

          zoomModal.addEventListener('click', () => {
            zoomModal.classList.add('hidden');
            zoomModal.classList.remove('flex', 'items-center', 'justify-center');
          });

          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              zoomModal.classList.add('hidden');
              zoomModal.classList.remove('flex', 'items-center', 'justify-center');
            }
          });
        }
      </script>

    </div>
  </section>
</Layout>





