---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
        id_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const isDoctor = specialtyName === "Medicina General";

if (!isDoctor && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const startOfToday = new Date();
startOfToday.setHours(0, 0, 0, 0);
const overdueSlots = await prisma.disponibilidadTrabajador.findMany({
  where: {
    id_trabajador: worker.id_trabajador,
    fecha: { lt: startOfToday },
    estado: { in: ["reservado", "confirmado", "ingresado", "en_curso"] },
  },
  select: { id_disponibilidad: true },
});

// Solo marcamos inasistencias cuando el dia termino y no existe registro de consulta medica.
if (overdueSlots.length > 0) {
  const slotIds = overdueSlots.map((slot) => slot.id_disponibilidad);
  let slotsWithConsult = new Set<number>();

  try {
    const recordedConsults =
      (await prisma.$queryRawUnsafe<{ id_disponibilidad: number }[]>(
        `SELECT id_disponibilidad FROM consulta_medica_slot WHERE id_disponibilidad IN (${slotIds.join(",")})`,
      )) ?? [];
    slotsWithConsult = new Set(recordedConsults.map((row) => Number(row.id_disponibilidad)));
  } catch (error) {
    console.warn("No se pudo verificar consultas registradas para cupos vencidos.", error);
  }

  const slotsWithoutConsult = slotIds.filter((slotId) => !slotsWithConsult.has(slotId));

  if (slotsWithoutConsult.length > 0) {
    await prisma.disponibilidadTrabajador.updateMany({
      where: { id_disponibilidad: { in: slotsWithoutConsult } },
      data: { estado: "no_se_presenta" },
    });
  }
}

const upcomingConsultations = await prisma.disponibilidadTrabajador.findMany({
  where: {
    id_trabajador: worker.id_trabajador,
    fecha: {
      gte: startOfToday,
    },
    estado: {
      in: ["reservado", "confirmado", "ingresado", "en_curso", "no_se_presenta"],
    },
  },
  include: {
    ingreso_enfermeria: true,
    paciente: {
      select: {
        id_paciente: true,
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
        correo_paciente: true,
        celular_paciente: true,
      },
    },
  },
  orderBy: { fecha: "asc" },
  take: 30,
});

const formatDate = (value: Date) =>
  value.toLocaleDateString("es-CL", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });

const groupedConsultations = upcomingConsultations.reduce((acc, consultation) => {
  const key = consultation.fecha.toISOString().split("T")[0];
  if (!acc.has(key)) {
    acc.set(key, {
      date: consultation.fecha,
      items: [],
    });
  }
  acc.get(key)?.items.push(consultation);
  return acc;
}, new Map());

const statusLabels: Record<string, string> = {
  reservado: "Reservado",
  confirmado: "Confirmado",
  ingresado: "Ingresado",
  en_curso: "En curso",
  finalizado: "Consulta finalizada",
  no_se_presenta: "No se presenta",
};

const workerFullName = [
  worker.primer_nombre_trabajador,
  worker.segundo_nombre_trabajador,
  worker.apellido_p_trabajador,
  worker.apellido_m_trabajador,
]
  .filter(Boolean)
  .join(" ");
---

<Layout title="Consultas programadas">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Medicina general</p>
        <h1 class="mt-3 text-3xl font-bold">Consultas agendadas</h1>
        <p class="mt-2 text-white/80">
          Profesional: <span class="font-semibold text-white">{workerFullName}</span>
        </p>
        <p class="mt-1 text-white/70">
          Especialidad: <span class="font-semibold text-white">{specialtyName}</span>
        </p>
        <p class="mt-4 text-sm text-white/60">
          Esta vista solo muestra las horas reservadas o confirmadas a partir de hoy. Recuerda actualizar el estado de cada bloque una vez finalizada la atencion.
        </p>
        <a
          href="/trabajador"
          class="mt-6 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver al panel principal
        </a>
      </header>

      {upcomingConsultations.length > 0 ? (
        <div class="space-y-8">
          <ul class="space-y-4">
            {upcomingConsultations.map((consultation) => {
              const patient = consultation.paciente;
              const patientName = patient
                ? [
                    patient.primer_nombre_paciente,
                    patient.segundo_nombre_paciente,
                    patient.apellido_p_paciente,
                    patient.apellido_m_paciente,
                  ]
                    .filter(Boolean)
                    .join(" ")
                : "Paciente pendiente";
              const hasIntake = Boolean(consultation.ingreso_enfermeria);
              const statusLabel = statusLabels[consultation.estado] ?? "Reservado";
              const slotId = consultation.id_disponibilidad;
              const patientId = patient?.id_paciente ?? null;
              return (
                <li
                  class="rounded-3xl border border-[#200934]/10 bg-white p-5 shadow-sm"
                  data-slot-id={slotId}
                  data-patient-id={patientId ?? ""}
                >
                  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                      <p class="text-lg font-semibold text-[#200934]">{patientName}</p>
                      <p class="text-sm text-[#200934]/70">{consultation.fecha.toLocaleString("es-CL", { dateStyle: "full", timeStyle: "short" })}</p>
                      <p class="text-xs font-semibold text-emerald-600" data-status-label>
                        {statusLabel}
                      </p>
                      {consultation.nota ? (
                        <p class="mt-2 text-sm text-[#200934]/80">
                          Nota del paciente: <span class="font-semibold text-[#200934]">{consultation.nota}</span>
                        </p>
                      ) : null}
                      {hasIntake && consultation.estado !== "no_se_presenta" ? (
                        <a
                          href={`/trabajador/consultas/${slotId}`}
                          class="mt-3 inline-flex rounded-2xl bg-[#321355] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
                          data-start-consult
                        >
                          {consultation.estado === "en_curso" ? "Continuar consulta" : "Iniciar consulta"}
                        </a>
                      ) : null}
                    </div>
                    {patient ? (
                      <div class="rounded-2xl bg-[#f4f1fb] p-4 text-sm text-[#200934]">
                        <p class="font-semibold">Contacto paciente</p>
                        <p class="text-[#200934]/80">Correo: {patient.correo_paciente ?? "Sin correo"}</p>
                        <p class="text-[#200934]/80">Telefono: {patient.celular_paciente ?? "Sin telefono"}</p>
                      </div>
                    ) : (
                      <p class="rounded-2xl bg-rose-50 p-4 text-sm text-rose-700">
                        Esta reserva aun no tiene paciente asignado. Verifica con admision.
                      </p>
                    )}
                  </div>
                </li>
              );
            })}
          </ul>
        </div>
      ) : (
        <p class="rounded-3xl border border-dashed border-[#200934]/20 bg-white p-6 text-sm text-[#200934]/70">
          No tienes reservas a partir de hoy. Una vez que los pacientes agenden horas en tu agenda, apareceran en este listado.
        </p>
      )}
    </div>
  </section>
</Layout>

<div id="history-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="max-h-[80vh] w-full max-w-2xl overflow-y-auto rounded-3xl bg-white p-6 shadow-2xl" data-history-container>
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-semibold text-[#200934]">Consultas anteriores</h3>
      <button type="button" class="text-sm font-semibold text-[#200934]" data-history-close>Cerrar</button>
    </div>
    <p class="mt-2 text-sm text-[#200934]/70">
      Ultimos registros guardados para este paciente.
    </p>
    <div class="mt-4 space-y-3 text-sm text-[#200934]" data-history-content>
      <p class="text-[#200934]/70">Selecciona un paciente para ver su historial.</p>
    </div>
  </div>
</div>

<div id="chronic-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="max-h-[80vh] w-full max-w-2xl overflow-y-auto rounded-3xl bg-white p-6 shadow-2xl" data-chronic-container>
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-semibold text-[#200934]">Antecedentes crónicos</h3>
      <button type="button" class="text-sm font-semibold text-[#200934]" data-chronic-close>Cerrar</button>
    </div>
    <div class="mt-4 space-y-3 text-sm text-[#200934]" data-chronic-content>
      <p class="text-[#200934]/70">Selecciona un paciente para ver sus antecedentes.</p>
    </div>
  </div>
</div>

<div id="consult-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="w-full max-w-md rounded-3xl bg-white p-6 text-center shadow-2xl">
    <p class="text-lg font-semibold text-[#200934]">¿Estas seguro que quieres terminar la consulta?</p>
    <p class="mt-2 text-sm text-[#200934]/70">Podras revisar el registro luego en el historial.</p>
    <div class="mt-6 flex justify-center gap-4 text-sm font-semibold">
      <button
        type="button"
        class="rounded-2xl bg-[#f4f1fb] px-5 py-2 text-[#200934]"
        data-confirm-no
      >
        No
      </button>
      <button
        type="button"
        class="rounded-2xl bg-[#321355] px-5 py-2 text-white"
        data-confirm-yes
      >
        Si
      </button>
    </div>
  </div>
</div>

<script type="module">
  const cards = document.querySelectorAll("[data-slot-id]");
  const historyModal = document.getElementById("history-modal");
  const chronicModal = document.getElementById("chronic-modal");
  const confirmModal = document.getElementById("consult-confirm-modal");
  const historyContent = historyModal?.querySelector("[data-history-content]");
  const chronicContent = chronicModal?.querySelector("[data-chronic-content]");
  const confirmNo = confirmModal?.querySelector("[data-confirm-no]");
  const confirmYes = confirmModal?.querySelector("[data-confirm-yes]");
  let pendingSave = null;

  const toggleModal = (modal, show) => {
    if (!modal) return;
    modal.classList.toggle("hidden", !show);
    modal.classList.toggle("flex", show);
    document.body.classList.toggle("overflow-hidden", show);
  };

  const fetchJSON = async (url, options) => {
    const response = await fetch(url, options);
    const result = await response.json().catch(() => null);
    if (!response.ok || !result) {
      throw new Error(result?.error ?? "Ocurrió un error inesperado.");
    }
    return result;
  };

  const openHistory = async (patientId) => {
    if (!historyModal || !historyContent || !patientId) return;
    toggleModal(historyModal, true);
    historyContent.innerHTML = `<p class="text-sm text-[#200934]/70">Cargando historial...</p>`;
    try {
      const data = await fetchJSON(`/api/consultas/historial?pacienteId=${patientId}`);
      if (!data.entries || data.entries.length === 0) {
        historyContent.innerHTML = `<p class="text-sm text-[#200934]/70">No se encontraron registros de consultas previas.</p>`;
        return;
      }
      historyContent.innerHTML = data.entries
        .map(
          (entry) => `
            <article class="rounded-2xl border border-[#200934]/10 p-3">
              <p class="text-xs text-[#200934]/60">${new Date(entry.created_at).toLocaleString("es-CL", {
                dateStyle: "medium",
                timeStyle: "short",
              })}</p>
              <p class="text-sm text-[#200934] mt-1">${entry.resumen}</p>
              ${
                entry.derivacion
                  ? `<p class="text-xs text-[#200934]/60 mt-1">Derivación: ${entry.derivacion}</p>`
                  : ""
              }
            </article>
          `
        )
        .join("");
    } catch (error) {
      historyContent.innerHTML = `<p class="text-sm text-rose-600">${error instanceof Error ? error.message : "No pudimos cargar el historial."}</p>`;
    }
  };

  const openChronic = async (patientId) => {
    if (!chronicModal || !chronicContent || !patientId) return;
    toggleModal(chronicModal, true);
    chronicContent.innerHTML = `<p class="text-sm text-[#200934]/70">Cargando antecedentes...</p>`;
    try {
      const data = await fetchJSON(`/api/consultas/cronico?pacienteId=${patientId}`);
      const { chronic, conditions, medications, treatments, exams } = data;
      chronicContent.innerHTML = `
        <p class="text-sm font-semibold text-[#200934]">Paciente ${chronic ? "crónico" : "sin registro crónico"}</p>
        <div class="mt-3 text-sm text-[#200934]/80 space-y-2">
          <div>
            <p class="font-semibold text-[#200934]">Enfermedades</p>
            <p>${conditions.length ? conditions.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Tratamientos</p>
            <p>${treatments.length ? treatments.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Medicamentos</p>
            <p>${medications.length ? medications.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Exámenes recientes</p>
            <p>${exams.length ? exams.join(", ") : "Sin información registrada"}</p>
          </div>
        </div>
      `;
    } catch (error) {
      chronicContent.innerHTML = `<p class="text-sm text-rose-600">${error instanceof Error ? error.message : "No pudimos cargar los antecedentes."}</p>`;
    }
  };

  cards.forEach((card) => {
    const openButton = card.querySelector("[data-open-consult]");
    const panel = card.querySelector("[data-consult-panel]");
    const historyButton = card.querySelector("[data-history-button]");
    const chronicButton = card.querySelector("[data-chronic-button]");
    const saveButton = card.querySelector("[data-save-button]");
    const summaryField = card.querySelector("[data-summary-field]");
    const derivationField = card.querySelector("[data-derivation-field]");
    const feedback = card.querySelector("[data-consult-feedback]");
    const errorBox = card.querySelector("[data-consult-error]");
    const statusLabel = card.querySelector("[data-status-label]");
    const slotId = Number(card.dataset.slotId);
    const patientId = Number(card.dataset.patientId);

    openButton?.addEventListener("click", () => panel?.classList.toggle("hidden"));
    historyButton?.addEventListener("click", () => openHistory(patientId));
    chronicButton?.addEventListener("click", () => openChronic(patientId));

    saveButton?.addEventListener("click", () => {
      if (!summaryField || !slotId || !patientId) return;
      if (!summaryField.value.trim()) {
        errorBox.hidden = false;
        errorBox.textContent = "Debes ingresar un resumen de la consulta.";
        return;
      }
      errorBox.hidden = true;
      feedback.hidden = true;
      pendingSave = {
        slotId,
        patientId,
        summary: summaryField.value.trim(),
        derivation: derivationField?.value ?? "",
        feedback,
        errorBox,
        panel,
        statusLabel,
        saveButton,
      };
      toggleModal(confirmModal, true);
    });
  });

  confirmNo?.addEventListener("click", () => {
    toggleModal(confirmModal, false);
    pendingSave = null;
  });

  confirmYes?.addEventListener("click", async () => {
    if (!pendingSave) {
      toggleModal(confirmModal, false);
      return;
    }
    confirmYes.setAttribute("disabled", "true");
    confirmYes.textContent = "Guardando...";
    try {
      const result = await fetchJSON("/api/consultas/finalizar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          disponibilidadId: pendingSave.slotId,
          pacienteId: pendingSave.patientId,
          resumen: pendingSave.summary,
          derivacion: pendingSave.derivation,
        }),
      });
      pendingSave.feedback.hidden = false;
      pendingSave.feedback.textContent = result.message ?? "Consulta guardada.";
      pendingSave.errorBox.hidden = true;
      pendingSave.panel?.classList.add("hidden");
      pendingSave.statusLabel.textContent = "Consulta finalizada";
      pendingSave.saveButton.setAttribute("disabled", "true");
    } catch (error) {
      pendingSave.errorBox.hidden = false;
      pendingSave.errorBox.textContent =
        error instanceof Error ? error.message : "No pudimos guardar la consulta.";
    } finally {
      confirmYes.removeAttribute("disabled");
      confirmYes.textContent = "Si";
      toggleModal(confirmModal, false);
      pendingSave = null;
    }
  });

  historyModal?.addEventListener("click", (event) => {
    if (event.target === historyModal || (event.target instanceof HTMLElement && event.target.dataset.historyClose !== undefined)) {
      toggleModal(historyModal, false);
    }
  });

  chronicModal?.addEventListener("click", (event) => {
    if (event.target === chronicModal || (event.target instanceof HTMLElement && event.target.dataset.chronicClose !== undefined)) {
      toggleModal(chronicModal, false);
    }
  });
</script>
