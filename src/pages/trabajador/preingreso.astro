---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
        id_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const isNurse = specialtyName === "Enfermeria";

if (!isNurse && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const startOfToday = new Date();
startOfToday.setHours(0, 0, 0, 0);
const endOfToday = new Date();
endOfToday.setHours(23, 59, 59, 999);

const nurseAppointments = await prisma.disponibilidadTrabajador.findMany({
  where: {
    fecha: {
      gte: startOfToday,
      lte: endOfToday,
    },
    estado: "reservado",
  },
  orderBy: { fecha: "asc" },
  include: {
    paciente: {
      select: {
        id_paciente: true,
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
        ingresos_enfermeria: {
          orderBy: { created_at: "desc" },
          take: 1,
          select: {
            altura: true,
            peso: true,
            signos_vitales: true,
            created_at: true,
          },
        },
      },
    },
    trabajador: {
      select: {
        primer_nombre_trabajador: true,
        segundo_nombre_trabajador: true,
        apellido_p_trabajador: true,
        apellido_m_trabajador: true,
        especialidad: {
          select: {
            nombre_especialidad: true,
          },
        },
      },
    },
  },
});

const formatTime = (value: Date) =>
  value.toLocaleTimeString("es-CL", { hour: "2-digit", minute: "2-digit" });

const workerFullName = [
  worker.primer_nombre_trabajador,
  worker.segundo_nombre_trabajador,
  worker.apellido_p_trabajador,
  worker.apellido_m_trabajador,
]
  .filter(Boolean)
  .join(" ");
---

<Layout title="Preingresos de enfermeria">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Enfermeria</p>
        <h1 class="mt-3 text-3xl font-bold">Preingresos del dia</h1>
        <p class="mt-2 text-white/80">
          {startOfToday.toLocaleDateString("es-CL", { dateStyle: "full" })}
        </p>
        <p class="mt-2 text-sm text-white/70">
          Profesional a cargo: <span class="font-semibold text-white">{workerFullName}</span> ({specialtyName})
        </p>
        <p class="mt-4 text-sm text-white/60">
          Registra signos vitales, altura y peso antes de derivar al paciente al profesional tratante.
        </p>
        <a
          href="/trabajador"
          class="mt-6 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver al panel del trabajador
        </a>
      </header>

      {nurseAppointments.length > 0 ? (
        <ul class="space-y-4">
          {nurseAppointments.map((appointment) => {
            const patient = appointment.paciente;
            const doctor = appointment.trabajador;
            const patientName = patient
              ? [
                  patient.primer_nombre_paciente,
                  patient.segundo_nombre_paciente,
                  patient.apellido_p_paciente,
                  patient.apellido_m_paciente,
                ]
                  .filter(Boolean)
                  .join(" ")
              : "Paciente sin registro";
            const doctorName = [
              doctor.primer_nombre_trabajador,
              doctor.segundo_nombre_trabajador,
              doctor.apellido_p_trabajador,
              doctor.apellido_m_trabajador,
            ]
              .filter(Boolean)
              .join(" ");
            const specialty = doctor.especialidad?.nombre_especialidad ?? "Medicina General";
            const lastRecord = patient?.ingresos_enfermeria?.[0] ?? null;
            const lastUpdatedLabel = lastRecord
              ? new Date(lastRecord.created_at).toLocaleString("es-CL", {
                  dateStyle: "medium",
                  timeStyle: "short",
                })
              : "Sin registros";
            return (
              <li class="rounded-3xl border border-[#200934]/15 bg-white/80 p-5 shadow-sm backdrop-blur">
                <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                  <div class="space-y-1 text-[#200934]">
                    <p class="text-lg font-semibold">{patientName}</p>
                    <p class="text-sm text-[#200934]/70">Hora de consulta: {formatTime(appointment.fecha)}</p>
                    <p class="text-sm text-[#200934]/70">Profesional: {doctorName} - {specialty}</p>
                    <p class="text-xs text-[#200934]/60">Ultimo registro: {lastUpdatedLabel}</p>
                  </div>
                  <button
                    type="button"
                    class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#200934] disabled:cursor-not-allowed disabled:bg-gray-400"
                    data-open-intake
                    data-disponibilidad={appointment.id_disponibilidad}
                    data-patient-name={patientName}
                    data-doctor-name={`${doctorName} - ${specialty}`}
                    data-appointment-time={formatTime(appointment.fecha)}
                    data-last-altura={lastRecord?.altura ?? ""}
                    data-last-peso={lastRecord?.peso ?? ""}
                    data-last-signos={lastRecord?.signos_vitales ?? ""}
                    data-last-updated={lastUpdatedLabel}
                    disabled={!patient}
                  >
                    Ingresar paciente
                  </button>
                </div>
              </li>
            );
          })}
        </ul>
      ) : (
        <p class="rounded-3xl border border-dashed border-[#200934]/20 bg-white/70 p-6 text-sm text-[#200934]/70">
          No hay reservas derivadas para hoy. Las nuevas tomas de hora apareceran automaticamente en este panel.
        </p>
      )}
    </div>
  </section>
</Layout>

<div id="nurse-intake-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-overlay></div>
  <div
    class="relative z-10 max-h-[90vh] w-full max-w-xl overflow-y-auto rounded-3xl bg-white p-6 shadow-2xl"
    data-modal-content
  >
    <div class="flex items-start justify-between gap-4">
      <div>
        <p class="text-sm uppercase tracking-[0.35em] text-[#200934]/60">Ingreso de enfermeria</p>
        <h3 class="mt-1 text-2xl font-semibold text-[#200934]" data-modal-patient>Paciente</h3>
        <p class="text-sm text-[#200934]/70" data-modal-doctor>Consulta</p>
      </div>
      <button
        type="button"
        class="rounded-full p-2 text-[#200934]/60 transition hover:bg-[#f4f1fb] hover:text-[#200934]"
        data-close-modal
        aria-label="Cerrar formulario"
      >
        X
      </button>
    </div>

    <form class="mt-6 space-y-4" data-intake-form>
      <input type="hidden" name="disponibilidadId" data-field-availability />
      <div class="grid gap-4 md:grid-cols-2">
        <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
          Altura (cm)
          <input
            type="number"
            name="altura"
            step="0.1"
            min="30"
            max="250"
            class="rounded-2xl border border-[#200934]/20 px-4 py-2 text-base font-normal text-[#200934] focus:border-[#200934] focus:outline-none"
            required
          />
        </label>
        <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
          Peso (kg)
          <input
            type="number"
            name="peso"
            step="0.1"
            min="1"
            max="400"
            class="rounded-2xl border border-[#200934]/20 px-4 py-2 text-base font-normal text-[#200934] focus:border-[#200934] focus:outline-none"
            required
          />
        </label>
      </div>
      <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
        Signos vitales
        <textarea
          name="signosVitales"
          rows="4"
          class="rounded-2xl border border-[#200934]/20 px-4 py-2 text-base font-normal text-[#200934] focus:border-[#200934] focus:outline-none"
          placeholder="Ej: Presion 120/80, FC 76 lpm, Saturacion 98%"
          required
        ></textarea>
      </label>

      <div class="rounded-3xl bg-[#f4f1fb] p-4 text-sm text-[#200934]" data-last-record>
        <p class="text-sm font-semibold text-[#200934]">Ultimo registro</p>
        <dl class="mt-2 space-y-1">
          <div class="flex justify-between">
            <dt>Altura:</dt>
            <dd data-last-height>Sin registros</dd>
          </div>
          <div class="flex justify-between">
            <dt>Peso:</dt>
            <dd data-last-weight>Sin registros</dd>
          </div>
          <div>
            <dt>Signos vitales:</dt>
            <dd class="mt-1 text-sm text-[#200934]/80" data-last-signos>Sin registros</dd>
          </div>
          <div class="flex justify-between text-xs text-[#200934]/60">
            <dt>Actualizado:</dt>
            <dd data-last-updated>Sin registros</dd>
          </div>
        </dl>
      </div>

      <p class="text-sm font-semibold text-emerald-600" data-feedback hidden></p>
      <p class="text-sm font-semibold text-red-600" data-error hidden></p>

      <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
        <button
          type="button"
          class="rounded-2xl border border-[#200934]/20 px-5 py-2 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/40"
          data-close-modal
        >
          Cancelar
        </button>
        <button
          type="submit"
          class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
          data-submit
        >
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<script type="module">
  const modal = document.getElementById("nurse-intake-modal");
  if (modal) {
    const overlay = modal.querySelector("[data-overlay]");
    const form = modal.querySelector("[data-intake-form]");
    const availabilityField = modal.querySelector("[data-field-availability]");
    const patientLabel = modal.querySelector("[data-modal-patient]");
    const doctorLabel = modal.querySelector("[data-modal-doctor]");
    const lastHeight = modal.querySelector("[data-last-height]");
    const lastWeight = modal.querySelector("[data-last-weight]");
    const lastSigns = modal.querySelector("[data-last-signos]");
    const lastUpdated = modal.querySelector("[data-last-updated]");
    const feedback = modal.querySelector("[data-feedback]");
    const errorBox = modal.querySelector("[data-error]");
    const submitButton = modal.querySelector("[data-submit]");

    const toggleModal = (show) => {
      modal.classList.toggle("hidden", !show);
      document.body.classList.toggle("overflow-hidden", show);
      if (!show) {
        feedback.hidden = true;
        errorBox.hidden = true;
        feedback.textContent = "";
        errorBox.textContent = "";
        form.reset();
      }
    };

    const hydrateLastRecord = ({ altura, peso, signos, updated }) => {
      lastHeight.textContent = altura ?? "Sin registros";
      lastWeight.textContent = peso ?? "Sin registros";
      lastSigns.textContent = signos ?? "Sin registros";
      lastUpdated.textContent = updated ?? "Sin registros";
    };

    document.querySelectorAll("[data-open-intake]").forEach((button) => {
      button.addEventListener("click", () => {
        availabilityField.value = button.dataset.disponibilidad ?? "";
        patientLabel.textContent = button.dataset.patientName ?? "Paciente";
        doctorLabel.textContent = `Hora: ${button.dataset.appointmentTime ?? ""} - ${
          button.dataset.doctorName ?? ""
        }`;
        hydrateLastRecord({
          altura: button.dataset.lastAltura || undefined,
          peso: button.dataset.lastPeso || undefined,
          signos: button.dataset.lastSignos || undefined,
          updated: button.dataset.lastUpdated || undefined,
        });
        toggleModal(true);
      });
    });

    [overlay, ...modal.querySelectorAll("[data-close-modal]")].forEach((element) => {
      element?.addEventListener("click", () => toggleModal(false));
    });

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        toggleModal(false);
      }
    });

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!availabilityField.value) {
        return;
      }
      submitButton.setAttribute("disabled", "true");
      submitButton.textContent = "Guardando...";
      feedback.hidden = true;
      errorBox.hidden = true;
      try {
        const formData = new FormData(form);
        const payload = {
          disponibilidadId: Number(formData.get("disponibilidadId")),
          altura: Number(formData.get("altura")),
          peso: Number(formData.get("peso")),
          signosVitales: String(formData.get("signosVitales") ?? ""),
        };
        const response = await fetch("/api/enfermeria/ingresos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const result = await response.json().catch(() => null);
        if (!response.ok || !result) {
          throw new Error(result?.error ?? "No pudimos guardar el registro.");
        }
        feedback.textContent = result.message ?? "Registro guardado.";
        feedback.hidden = false;
        hydrateLastRecord({
          altura: `${result.record?.altura ?? payload.altura} cm`,
          peso: `${result.record?.peso ?? payload.peso} kg`,
          signos: result.record?.signos_vitales ?? payload.signosVitales,
          updated: result.record?.updated_at
            ? new Date(result.record.updated_at).toLocaleString("es-CL", {
                dateStyle: "medium",
                timeStyle: "short",
              })
            : new Date().toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }),
        });
      } catch (err) {
        console.error(err);
        errorBox.textContent = err instanceof Error ? err.message : "Error inesperado.";
        errorBox.hidden = false;
      } finally {
        submitButton.removeAttribute("disabled");
        submitButton.textContent = "Guardar";
      }
    });
  }
</script>
