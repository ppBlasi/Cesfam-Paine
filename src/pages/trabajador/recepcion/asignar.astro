---
import Layout from "../../../layouts/Layout.astro";
import { prisma } from "../../../lib/prisma";
import { normalizeRut } from "../../../utils/rut";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
        id_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const isReception = specialtyName === "Recepcion";

if (!isReception && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const rutQuery = Astro.url.searchParams.get("rut")?.trim() ?? "";
let normalizedRut = "";
let patient = null;
let searchError = "";

if (rutQuery) {
  normalizedRut = normalizeRut(rutQuery);
  if (!normalizedRut) {
    searchError = "El RUT ingresado no es valido.";
  } else {
    patient = await prisma.paciente.findFirst({
      where: { rut_paciente: normalizedRut },
      select: {
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
        correo_paciente: true,
        celular_paciente: true,
      },
    });

    if (!patient) {
      searchError = "No encontramos un paciente con ese RUT. Revisa la informacion.";
    }
  }
}

const today = new Date();
today.setHours(0, 0, 0, 0);
const todayISO = today.toISOString().split("T")[0];

const patientFullName = patient
  ? [
      patient.primer_nombre_paciente,
      patient.segundo_nombre_paciente,
      patient.apellido_p_paciente,
      patient.apellido_m_paciente,
    ]
      .filter(Boolean)
      .join(" ")
  : null;
---

<Layout title="Asignar reservas - Recepcion">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Modulo de recepcion</p>
        <h1 class="mt-3 text-3xl font-bold">Asignar una nueva reserva</h1>
        <p class="mt-2 text-white/80">
          Profesional: <span class="font-semibold text-white">{worker.primer_nombre_trabajador} {worker.apellido_p_trabajador}</span>
        </p>
        <p class="mt-1 text-white/70">Especialidad: <span class="font-semibold text-white">{specialtyName}</span></p>
        <p class="mt-4 text-sm text-white/60">
          Ingresa el RUT del paciente. Una vez validado, selecciona la fecha desde el calendario y confirma la hora disponible.
        </p>
        <a
          href="/trabajador"
          class="mt-6 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver al panel principal
        </a>
      </header>

      <form class="rounded-3xl bg-white p-6 shadow-lg" method="GET">
        <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
          RUT del paciente
          <input
            type="text"
            name="rut"
            placeholder="Ej: 11.111.111-1"
            value={rutQuery}
            class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-base text-[#200934] focus:border-[#200934] focus:outline-none"
            required
          />
        </label>
        <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <p class="text-xs text-[#200934]/70">El buscador acepta formatos con y sin puntos. Se validara automaticamente.</p>
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
          >
            Validar paciente
          </button>
        </div>
      </form>

      {searchError ? (
        <p class="rounded-3xl bg-rose-100 px-4 py-3 text-sm font-semibold text-rose-700">{searchError}</p>
      ) : null}

      {patient ? (
        <section
          class="rounded-3xl bg-white p-6 shadow-lg"
          data-assignment-panel
          data-patient-rut={normalizedRut}
          data-min-date={todayISO}
        >
          <div class="border-b border-[#200934]/10 pb-4">
            <h2 class="text-xl font-semibold text-[#200934]">Paciente validado</h2>
            <p class="text-sm text-[#200934]/70">
              Nombre completo: <span class="font-semibold text-[#200934]">{patientFullName}</span>
            </p>
            <p class="text-sm text-[#200934]/70">Correo: {patient.correo_paciente || "Sin informacion"}</p>
            <p class="text-sm text-[#200934]/70">Telefono: {patient.celular_paciente || "Sin informacion"}</p>
          </div>

          <div class="mt-4 grid gap-4 md:grid-cols-2">
            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Selecciona la fecha
              <input
                type="date"
                data-date-input
                min={todayISO}
                class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-base text-[#200934] focus:border-[#200934] focus:outline-none"
                required
              />
            </label>
            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Nota para el profesional (opcional)
              <textarea
                rows="3"
                maxlength="240"
                data-note-input
                class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-base text-[#200934] focus:border-[#200934] focus:outline-none"
                placeholder="Motivo de la reserva u observaciones"
              ></textarea>
            </label>
          </div>

          <div class="mt-6 space-y-3">
            <p class="text-sm font-semibold text-[#200934]" data-slot-message>
              Selecciona una fecha para ver los horarios disponibles.
            </p>
            <div class="grid gap-3 sm:grid-cols-2" data-slot-list></div>
            <p class="text-sm text-[#200934]/70" data-selected-slot-text hidden></p>
            <div class="flex justify-end">
              <button
                type="button"
                class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#200934] disabled:cursor-not-allowed disabled:bg-[#b4a6c9]"
                data-reserve-button
                disabled
              >
                Reservar hora
              </button>
            </div>
          </div>

          <p class="mt-4 text-sm font-semibold text-emerald-600" data-feedback hidden></p>
          <p class="mt-2 text-sm font-semibold text-rose-600" data-error hidden></p>
        </section>
      ) : null}
    </div>
  </section>
</Layout>

{patient ? (
  <script type="module">
    const panel = document.querySelector("[data-assignment-panel]");
    if (panel) {
      const rut = panel.dataset.patientRut;
      const minDate = panel.dataset.minDate;
      const dateInput = panel.querySelector("[data-date-input]");
      const noteInput = panel.querySelector("[data-note-input]");
      const slotList = panel.querySelector("[data-slot-list]");
      const slotMessage = panel.querySelector("[data-slot-message]");
      const selectedSlotText = panel.querySelector("[data-selected-slot-text]");
      const reserveButton = panel.querySelector("[data-reserve-button]");
      const feedback = panel.querySelector("[data-feedback]");
      const errorBox = panel.querySelector("[data-error]");
      let selectedSlotId = null;

      const setMessage = (text) => {
        if (slotMessage) {
          slotMessage.textContent = text;
        }
      };

      const clearSelection = () => {
        selectedSlotId = null;
        if (selectedSlotText) {
          selectedSlotText.hidden = true;
          selectedSlotText.textContent = "";
        }
        if (reserveButton) {
          reserveButton.setAttribute("disabled", "true");
        }
      };

      const renderSlots = (slots) => {
        if (!slotList) return;
        slotList.innerHTML = "";
        clearSelection();
        if (!slots || slots.length === 0) {
          setMessage("No hay horarios disponibles para esta fecha.");
          return;
        }
        setMessage("Selecciona una hora para confirmar la reserva.");
        slots.forEach((slot) => {
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = `${slot.time} Â· ${slot.doctor}`;
          button.className =
            "rounded-2xl border border-[#200934]/20 bg-[#f4f1fb] px-4 py-3 text-sm font-semibold text-[#200934] transition hover:border-[#200934]/60 hover:bg-white";
          button.dataset.slotId = String(slot.id);
          button.addEventListener("click", () => {
            selectedSlotId = slot.id;
            slotList.querySelectorAll("button").forEach((btn) => btn.classList.remove("border-[#200934]", "bg-white"));
            button.classList.add("border-[#200934]", "bg-white");
            if (selectedSlotText) {
              selectedSlotText.hidden = false;
              selectedSlotText.textContent = `Hora seleccionada: ${slot.time} con ${slot.doctor} (${slot.specialty}).`;
            }
            if (reserveButton) {
              reserveButton.removeAttribute("disabled");
            }
          });
          slotList.appendChild(button);
        });
      };

      const fetchSlots = async (date) => {
        if (!date) return;
        setMessage("Buscando horarios disponibles...");
        slotList.innerHTML = "";
        try {
          const response = await fetch(`/api/recepcion/disponibles?date=${date}`);
          const result = await response.json().catch(() => null);
          if (!response.ok || !result) {
            throw new Error(result?.error ?? "No pudimos obtener los horarios.");
          }
          renderSlots(result.slots ?? []);
        } catch (err) {
          console.error(err);
          setMessage(err instanceof Error ? err.message : "Error al cargar horarios.");
        }
      };

      const assignSlot = async (slotId) => {
        if (!rut || !slotId) return;
        feedback.hidden = true;
        errorBox.hidden = true;
        try {
          const response = await fetch("/api/recepcion/asignar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              rut,
              disponibilidadId: slotId,
              nota: noteInput?.value ?? "",
            }),
          });
          const result = await response.json().catch(() => null);
          if (!response.ok || !result) {
            throw new Error(result?.error ?? "No pudimos asignar la hora.");
          }
          feedback.textContent = result.message ?? "Hora asignada correctamente.";
          feedback.hidden = false;
          if (noteInput) {
            noteInput.value = "";
          }
          if (dateInput?.value) {
            fetchSlots(dateInput.value);
          }
        } catch (err) {
          console.error(err);
          errorBox.textContent = err instanceof Error ? err.message : "Error inesperado al asignar.";
          errorBox.hidden = false;
        }
      };

      if (dateInput) {
        if (minDate) {
          dateInput.value = minDate;
        }
        dateInput.addEventListener("change", () => {
          if (dateInput.value) {
            fetchSlots(dateInput.value);
          }
        });
        if (dateInput.value) {
          fetchSlots(dateInput.value);
        }
      }

      reserveButton?.addEventListener("click", () => {
        if (selectedSlotId) {
          assignSlot(selectedSlotId);
        }
      });
    }
  </script>
) : null}
