---
import Layout from "../../../layouts/Layout.astro";
import { prisma } from "../../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const slotId = Number(Astro.params.id);

if (!Number.isInteger(slotId) || slotId <= 0) {
  return Astro.redirect("/trabajador/consultas");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
        id_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const isDoctor = worker.cargo === "MEDICO";
const isGeneralDoctor = isDoctor && specialtyName === "Medicina General";

if (!isDoctor && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const slot = await prisma.disponibilidadTrabajador.findFirst({
  where: {
    id_disponibilidad: slotId,
    id_trabajador: worker.id_trabajador,
  },
  include: {
    paciente: {
      select: {
        id_paciente: true,
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
        correo_paciente: true,
        celular_paciente: true,
      },
    },
    ingreso_enfermeria: true,
  },
});

if (!slot || !slot.paciente) {
  return Astro.redirect("/trabajador/consultas");
}

const patient = slot.paciente;
const patientFullName = [
  patient.primer_nombre_paciente,
  patient.segundo_nombre_paciente,
  patient.apellido_p_paciente,
  patient.apellido_m_paciente,
]
  .filter(Boolean)
  .join(" ");

const especialidades = await prisma.especialidad.findMany({
  select: { nombre_especialidad: true },
  orderBy: { nombre_especialidad: "asc" },
});

const derivacionOptions = Array.from(
  new Map(
    especialidades
      .map((item) => item.nombre_especialidad?.trim())
      .filter(Boolean)
      .map((name) => [name.toLowerCase(), name]),
  ).values(),
);

const examenesCatalogo = worker.especialidad
  ? await prisma.examenEspecialidad.findMany({
      where: { id_especialidad: worker.especialidad.id_especialidad },
      orderBy: { nombre_examen: "asc" },
    })
  : [];

const medicamentosCatalogo: { nombre_medicamento: string }[] =
  worker.especialidad && (prisma as any).medicamentoEspecialidad?.findMany
    ? await (prisma as any).medicamentoEspecialidad.findMany({
        where: { id_especialidad: worker.especialidad.id_especialidad },
        orderBy: { nombre_medicamento: "asc" },
      })
    : [];

const medicamentosSugeridos: string[] = medicamentosCatalogo.map(
  (item) => item.nombre_medicamento,
);
const medicamentosJson = JSON.stringify(medicamentosSugeridos ?? []);
---

<Layout title="Consulta en curso">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">{specialtyName}</p>
        <h1 class="mt-3 text-3xl font-bold">Consulta con {patientFullName}</h1>
        <p class="mt-2 text-white/80">
          Programada para:{" "}
          <span class="font-semibold text-white">
            {slot.fecha.toLocaleString("es-CL", { dateStyle: "full", timeStyle: "short" })}
          </span>
        </p>
        <p class="mt-1 text-white/70">Estado actual: {slot.ingreso_enfermeria ? "En curso" : "Reservado"}</p>
        <a
          href="/trabajador/consultas"
          class="mt-6 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver a la agenda
        </a>
      </header>

      <section class="rounded-3xl bg-white p-6 shadow-lg">
        <h2 class="text-xl font-semibold text-[#200934]">Resumen de la consulta</h2>
        <p class="mt-1 text-sm text-[#200934]/70">
          Describe hallazgos, indicaciones y acuerdos con el paciente. Al guardar, la consulta se dará por finalizada.
        </p>

        <form class="mt-4 space-y-4" data-consultation-form>
          <input type="hidden" name="slotId" value={slotId} />
          <input type="hidden" name="patientId" value={patient.id_paciente} />

          <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
            Resumen
            <textarea
              name="resumen"
              rows="5"
              maxlength="800"
              class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
              placeholder="Detalle los antecedentes de esta consulta."
              required
            ></textarea>
          </label>

          {isGeneralDoctor ? (
            <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
              Posible diagnóstico (Medicina General)
              <select
                name="diagnostico"
                data-diagnosis-select
                class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
              >
                <option value="">Selecciona una opción</option>
                <option value="Hipertensión arterial">Hipertensión arterial</option>
                <option value="Diabetes mellitus tipo 2">Diabetes mellitus tipo 2</option>
                <option value="Dislipidemia mixta">Dislipidemia mixta</option>
              </select>
            </label>
          ) : null}

          <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
            Derivar a
            <select
              name="derivacion"
              class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
            >
              <option value="">Sin derivación</option>
              {derivacionOptions.length === 0 ? (
                <option disabled>No hay especialidades registradas</option>
              ) : (
                derivacionOptions.map((nombre) => (
                  <option value={nombre}>{nombre}</option>
                ))
              )}
            </select>
          </label>

          <div class="rounded-3xl bg-[#f9f7ff] p-4">
            <p class="text-sm font-semibold text-[#200934]">Tratamiento</p>
            <p class="text-xs text-[#200934]/70">Agrega medicamentos con indicaciones, frecuencia y duración.</p>
            <div class="mt-3 grid gap-3 md:grid-cols-2">
              <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                Medicamento
                <select
                  data-treatment-med-select
                  name="medicamento"
                  id="treatment-med-select"
                  class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                >
                  <option value="">Selecciona un medicamento</option>
                  {medicamentosSugeridos.map((nombre) => (
                    <option value={nombre}>{nombre}</option>
                  ))}
                </select>
              </label>
              <div class="grid gap-3 md:grid-cols-2" data-treatment-fields hidden>
                <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                  Frecuencia
                  <input
                    type="text"
                    data-treatment-frequency
                    class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                    placeholder="Ej: 1 cada 8 horas"
                  />
                </label>
                <label class="flex flex-col gap-1 text-xs font-semibold text-[#200934]">
                  Duración
                  <input
                    type="text"
                    data-treatment-duration
                    class="rounded-xl border border-[#200934]/20 px-3 py-2 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
                    placeholder="Ej: 7 días"
                  />
                </label>
              </div>
            </div>
            {medicamentosSugeridos.length === 0 && (
              <p class="mt-3 text-xs text-rose-600">
                No hay medicamentos configurados para esta especialidad.
              </p>
            )}
            <button
              type="button"
              class="mt-3 inline-flex rounded-2xl bg-[#321355] px-4 py-2 text-xs font-semibold text-white transition hover:bg-[#200934]"
              data-add-treatment
            >
              Asignar medicamento
            </button>
            <ul class="mt-4 space-y-2 text-sm text-[#200934]" data-treatment-list></ul>
          </div>

          <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
            Orden de exámenes
            <textarea
              rows="3"
              maxlength="400"
              data-exams-field
              class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-sm text-[#200934] focus:border-[#200934] focus:outline-none"
              placeholder="Selecciona exámenes."
              readonly
            ></textarea>
            <div class="mt-2 flex flex-wrap gap-2" data-exams-selected></div>
            {examenesCatalogo.length > 0 ? (
              <div class="mt-2 space-y-2">
                <p class="text-xs text-[#200934]/70">Selecciona un examen sugerido.</p>
                <div class="flex flex-wrap gap-2">
                  {examenesCatalogo.map((item) => (
                    <button
                      type="button"
                      class="rounded-full bg-[#f4f1fb] px-3 py-1 text-xs font-semibold text-[#200934] transition hover:bg-[#e7def5]"
                      data-exam-suggest={item.nombre_examen}
                    >
                      {item.nombre_examen}
                    </button>
                  ))}
                </div>
              </div>
            ) : (
              <p class="mt-1 text-xs text-[#200934]/60">No hay exámenes asociados a tu especialidad.</p>
            )}
          </label>

          <div class="border-t-2"></div>

          <div class="flex flex-wrap gap-3 text-sm font-semibold text-[#200934]">
            <button
              type="button"
              class="rounded-2xl bg-[#f4f1fb] px-4 py-2 text-sm font-semibold text-[#200934] transition hover:bg-[#e7def5]"
              data-history-button
              data-patient-id={patient.id_paciente}
            >
              Ver consultas anteriores
            </button>
            <button
              type="button"
              class="rounded-2xl bg-[#f4f1fb] px-4 py-2 text-sm font-semibold text-[#200934] transition hover:bg-[#e7def5]"
              data-chronic-button
              data-patient-id={patient.id_paciente}
            >
              Ver antecedentes crónicos
            </button>
            <button
              type="button"
              class="rounded-2xl bg-[#321355] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
              data-save-button
            >
              Guardar consulta
            </button>
          </div>
          <p class="text-sm font-semibold text-emerald-600" data-feedback hidden></p>
          <p class="text-sm font-semibold text-rose-600" data-error hidden></p>
        </form>
      </section>
    </div>
  </section>
</Layout>

<div id="history-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="max-h-[80vh] w-full max-w-2xl overflow-y-auto rounded-3xl bg-white p-6 shadow-2xl" data-history-container>
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-semibold text-[#200934]">Consultas anteriores</h3>
      <button type="button" class="text-sm font-semibold text-[#200934]" data-history-close>Cerrar</button>
    </div>
    <div class="mt-4 space-y-3 text-sm text-[#200934]" data-history-content>
      <p class="text-[#200934]/70">Selecciona un paciente para ver su historial.</p>
    </div>
  </div>
</div>

<div id="chronic-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="max-h-[80vh] w-full max-w-2xl overflow-y-auto rounded-3xl bg-white p-6 shadow-2xl" data-chronic-container>
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-semibold text-[#200934]">Antecedentes crónicos</h3>
      <button type="button" class="text-sm font-semibold text-[#200934]" data-chronic-close>Cerrar</button>
    </div>
    <div class="mt-4 space-y-3 text-sm text-[#200934]" data-chronic-content>
      <p class="text-[#200934]/70">Selecciona un paciente para ver sus antecedentes.</p>
    </div>
  </div>
</div>

<div id="consult-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
  <div class="w-full max-w-md rounded-3xl bg-white p-6 text-center shadow-2xl">
    <p class="text-lg font-semibold text-[#200934]">¿Estas seguro que quieres terminar la consulta?</p>
    <p class="mt-2 text-sm text-[#200934]/70">Podrás revisar el registro luego en el historial.</p>
    <div class="mt-6 flex justify-center gap-4 text-sm font-semibold">
      <button type="button" class="rounded-2xl bg-[#f4f1fb] px-5 py-2 text-[#200934]" data-confirm-no>No</button>
      <button type="button" class="rounded-2xl bg-[#321355] px-5 py-2 text-white" data-confirm-yes>Si</button>
    </div>
  </div>
</div>

<script type="application/json" id="meds-data" set:html={medicamentosJson}></script>

<script type="module">
  const form = document.querySelector("[data-consultation-form]");
  const historyModal = document.getElementById("history-modal");
  const chronicModal = document.getElementById("chronic-modal");
  const confirmModal = document.getElementById("consult-confirm-modal");
  const historyContent = historyModal?.querySelector("[data-history-content]");
  const chronicContent = chronicModal?.querySelector("[data-chronic-content]");
  const confirmNo = confirmModal?.querySelector("[data-confirm-no]");
  const confirmYes = confirmModal?.querySelector("[data-confirm-yes]");
  const historyButton = document.querySelector("[data-history-button]");
  const chronicButton = document.querySelector("[data-chronic-button]");
  const saveButton = document.querySelector("[data-save-button]");
  const addTreatmentButton = form?.querySelector("[data-add-treatment]");
  const treatmentList = form?.querySelector("[data-treatment-list]");
  const treatmentMedSelect = form?.querySelector("[data-treatment-med-select]");
  const treatmentFields = form?.querySelector("[data-treatment-fields]");
  const treatmentFreqInput = form?.querySelector("[data-treatment-frequency]");
  const treatmentDurationInput = form?.querySelector("[data-treatment-duration]");
  const diagnosisSelect = form?.querySelector("[data-diagnosis-select]");
  const examsField = form?.querySelector("[data-exams-field]");
  const selectedExamsContainer = form?.querySelector("[data-exams-selected]");
  const examButtons = Array.from(form?.querySelectorAll("[data-exam-suggest]") ?? []);
  const feedback = form?.querySelector("[data-feedback]");
  const errorBox = form?.querySelector("[data-error]");
  const slotId = Number(form?.slotId.value);
  const patientId = Number(form?.patientId.value);
  const medsData = document.getElementById("meds-data");
  const readMedsFromSelect = () => {
    if (!(treatmentMedSelect instanceof HTMLSelectElement)) return [];
    return Array.from(treatmentMedSelect.options)
      .map((opt) => opt.value.trim())
      .filter(Boolean);
  };
  const medicamentosSugeridos = (() => {
    try {
      const raw = medsData?.textContent?.trim();
      if (!raw) return readMedsFromSelect();
      return JSON.parse(raw);
    } catch (error) {
      console.error("No se pudo leer el catálogo de medicamentos", error);
      return readMedsFromSelect();
    }
  })();
  let pendingPayload = null;
  let treatments = [];

  const toggleModal = (modal, show) => {
    if (!modal) return;
    modal.classList.toggle("hidden", !show);
    modal.classList.toggle("flex", show);
    document.body.classList.toggle("overflow-hidden", show);
  };

  const fetchJSON = async (url, options) => {
    const response = await fetch(url, options);
    const result = await response.json().catch(() => null);
    if (!response.ok || !result) {
      throw new Error(result?.error ?? "Se produjo un error inesperado.");
    }
    return result;
  };

  const normalizeExam = (value) => value.trim().replace(/\s+/g, " ");
  const parseExamList = (value) =>
    Array.from(new Set((value ?? "").split(",").map(normalizeExam).filter(Boolean)));

  let selectedExams = parseExamList(examsField?.value ?? "");
  let availableMeds = Array.from(new Set(medicamentosSugeridos ?? []));

  const toggleTreatmentFields = () => {
    if (!(treatmentFields instanceof HTMLElement)) return;
    const hasSelection = Boolean(treatmentMedSelect?.value?.trim());
    treatmentFields.toggleAttribute("hidden", !hasSelection);
    if (hasSelection) {
      treatmentFreqInput?.focus?.();
    } else {
      treatmentFreqInput && (treatmentFreqInput.value = "");
      treatmentDurationInput && (treatmentDurationInput.value = "");
    }
  };

  const renderMedOptions = () => {
    if (!(treatmentMedSelect instanceof HTMLSelectElement)) return;
    const current = treatmentMedSelect.value;
    treatmentMedSelect.innerHTML = "";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Selecciona un medicamento";
    treatmentMedSelect.appendChild(placeholder);

    availableMeds.forEach((med) => {
      const option = document.createElement("option");
      option.value = med;
      option.textContent = med;
      treatmentMedSelect.appendChild(option);
    });

    treatmentMedSelect.value = availableMeds.includes(current) ? current : "";
    toggleTreatmentFields();
  };

  const renderSelectedExams = () => {
    if (examsField) {
      examsField.value = selectedExams.join(", ");
    }
    if (!selectedExamsContainer) return;
    if (selectedExams.length === 0) {
      selectedExamsContainer.innerHTML = `<span class="text-xs text-[#200934]/60">Sin exámenes seleccionados.</span>`;
      return;
    }
    selectedExamsContainer.innerHTML = selectedExams
      .map(
        (exam) => `
          <span class="inline-flex items-center gap-2 rounded-full bg-[#f4f1fb] px-3 py-1 text-xs font-semibold text-[#200934]">
            <span>${exam}</span>
            <button
              type="button"
              class="text-[#200934]/60 transition hover:text-rose-600"
              data-remove-exam="${exam}"
              aria-label="Quitar examen ${exam}"
            >
              &times;
            </button>
          </span>
        `,
      )
      .join("");
  };

  renderSelectedExams();
  renderMedOptions();

  treatmentMedSelect?.addEventListener("change", toggleTreatmentFields);
  toggleTreatmentFields();

  examButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const exam = normalizeExam(btn.getAttribute("data-exam-suggest") ?? "");
      if (!exam) return;
      const exists = selectedExams.some((item) => item.toLowerCase() === exam.toLowerCase());
      if (exists) return;
      selectedExams.push(exam);
      renderSelectedExams();
    });
  });

  selectedExamsContainer?.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const removeBtn = target.closest("[data-remove-exam]");
    if (!removeBtn) return;
    const exam = removeBtn.getAttribute("data-remove-exam") ?? "";
    const index = selectedExams.findIndex((item) => item.toLowerCase() === exam.toLowerCase());
    if (index >= 0) {
      selectedExams.splice(index, 1);
      renderSelectedExams();
    }
  });

  historyButton?.addEventListener("click", async () => {
    if (!historyModal || !historyContent) return;
    toggleModal(historyModal, true);
    historyContent.innerHTML = `<p class="text-sm text-[#200934]/70">Cargando historial...</p>`;
    try {
      const data = await fetchJSON(`/api/consultas/${slotId}/historial?pacienteId=${patientId}`);
      if (!data.entries || data.entries.length === 0) {
        historyContent.innerHTML = `<p class="text-sm text-[#200934]/70">No se encontraron registros previos.</p>`;
        return;
      }
      historyContent.innerHTML = data.entries
        .map(
          (entry) => `
            <article class="rounded-2xl border border-[#200934]/10 p-3">
              <p class="text-xs text-[#200934]/60">${new Date(entry.created_at).toLocaleString("es-CL", {
                dateStyle: "medium",
                timeStyle: "short",
              })}</p>
              <p class="text-xs text-[#200934]/70 mt-1">
                Atendido por: ${entry.doctor_full_name ?? "Sin registro"}
              </p>
              ${
                entry.diagnostico
                  ? `<p class="text-xs text-[#200934]/70 mt-1">Diagnóstico: ${entry.diagnostico}</p>`
                  : ""
              }
              <p class="text-sm text-[#200934] mt-1">${entry.resumen}</p>
              ${
                entry.derivacion
                  ? `<p class="text-xs text-[#200934]/60 mt-1">Derivación: ${entry.derivacion}</p>`
                  : ""
              }
              ${
                entry.tratamiento
                  ? `<div class="mt-2 text-xs text-[#200934]">
                      <p class="font-semibold">Tratamiento</p>
                      ${
                        Array.isArray(entry.tratamiento)
                          ? entry.tratamiento
                              .map(
                                (item) =>
                                  `<p class="text-[#200934]/70">• ${item.medicamento} cada ${item.frecuencia} por ${item.duracion}</p>`
                              )
                              .join("")
                          : `<p class="text-[#200934]/70">${entry.tratamiento}</p>`
                      }
                    </div>`
                  : ""
              }
              ${
                entry.orden_examenes
                  ? `<p class="text-xs text-[#200934]/60 mt-1">Orden de exámenes: ${entry.orden_examenes}</p>`
                  : ""
              }
            </article>
          `
        )
        .join("");
    } catch (error) {
      historyContent.innerHTML = `<p class="text-sm text-rose-600">${error instanceof Error ? error.message : "No pudimos cargar el historial."}</p>`;
    }
  });

  chronicButton?.addEventListener("click", async () => {
    if (!chronicModal || !chronicContent) return;
    toggleModal(chronicModal, true);
    chronicContent.innerHTML = `<p class="text-sm text-[#200934]/70">Cargando antecedentes...</p>`;
    try {
      const data = await fetchJSON(`/api/consultas/${slotId}/cronico?pacienteId=${patientId}`);
      const { chronic, conditions, treatments, medications, exams } = data;
      chronicContent.innerHTML = `
        <p class="text-sm font-semibold text-[#200934]">Paciente ${chronic ? "crónico" : "sin registro crónico"}</p>
        <div class="mt-3 text-sm text-[#200934]/80 space-y-2">
          <div>
            <p class="font-semibold text-[#200934]">Enfermedades</p>
            <p>${conditions.length ? conditions.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Tratamientos</p>
            <p>${treatments.length ? treatments.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Medicamentos</p>
            <p>${medications.length ? medications.join(", ") : "Sin información registrada"}</p>
          </div>
          <div>
            <p class="font-semibold text-[#200934]">Exámenes recientes</p>
            <p>${exams.length ? exams.join(", ") : "Sin información registrada"}</p>
          </div>
        </div>
      `;
    } catch (error) {
      chronicContent.innerHTML = `<p class="text-sm text-rose-600">${error instanceof Error ? error.message : "No pudimos cargar los antecedentes."}</p>`;
    }
  });

  const renderTreatments = () => {
    if (!treatmentList) return;
    if (treatments.length === 0) {
      treatmentList.innerHTML = `<li class="text-xs text-[#200934]/60">Sin tratamientos asignados.</li>`;
      return;
    }
    treatmentList.innerHTML = treatments
      .map(
        (item, index) => `
        <li class="rounded-2xl border border-[#200934]/10 px-4 py-2 text-sm flex items-center justify-between gap-2">
          <div>
            <p class="font-semibold">${item.medicamento}</p>
            <p class="text-xs text-[#200934]/70">
              Frecuencia: ${item.frecuencia} · Duración: ${item.duracion}
            </p>
          </div>
          <button
            type="button"
            class="text-xs font-semibold text-rose-600"
            data-remove-treatment="${index}"
          >
            Quitar
          </button>
        </li>
      `
      )
      .join("");
  };

  renderTreatments();

  addTreatmentButton?.addEventListener("click", () => {
    const medicamento = treatmentMedSelect?.value.trim() ?? "";
    const frecuencia = treatmentFreqInput?.value.trim() ?? "";
    const duracion = treatmentDurationInput?.value.trim() ?? "";

    if (!medicamento) {
      errorBox.hidden = false;
      errorBox.textContent = "Debes seleccionar un medicamento.";
      return;
    }

    if (!frecuencia || !duracion) {
      errorBox.hidden = false;
      errorBox.textContent = "Completa todos los campos del tratamiento antes de agregarlo.";
      return;
    }

    treatments.push({ medicamento, frecuencia, duracion });
    availableMeds = availableMeds.filter((med) => med.toLowerCase() !== medicamento.toLowerCase());
    renderTreatments();
    renderMedOptions();

    treatmentFreqInput.value = "";
    treatmentDoseInput.value = "";
    treatmentDurationInput.value = "";
    if (treatmentFields instanceof HTMLElement) {
      treatmentFields.toggleAttribute("hidden", true);
    }
    errorBox.hidden = true;
  });

  treatmentList?.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const index = target.dataset.removeTreatment;
    if (index !== undefined) {
      const [removed] = treatments.splice(Number(index), 1);
      if (removed?.medicamento) {
        const exists = availableMeds.some(
          (med) => med.toLowerCase() === removed.medicamento.toLowerCase(),
        );
        if (!exists) {
          availableMeds.push(removed.medicamento);
          availableMeds = Array.from(new Set(availableMeds));
          renderMedOptions();
        }
      }
      renderTreatments();
    }
  });

  saveButton?.addEventListener("click", () => {
    const formData = new FormData(form);
    const resumen = String(formData.get("resumen") ?? "").trim();
    const diagnostico = String(formData.get("diagnostico") ?? "").trim();
    const derivacion = String(formData.get("derivacion") ?? "").trim();

    if (!resumen) {
      errorBox.hidden = false;
      errorBox.textContent = "Debes ingresar un resumen de la consulta.";
      return;
    }

    errorBox.hidden = true;
    feedback.hidden = true;
    pendingPayload = {
      resumen,
      diagnostico,
      derivacion,
      tratamientos: treatments,
      exams: examsField?.value.trim() ?? "",
    };
    toggleModal(confirmModal, true);
  });

  confirmNo?.addEventListener("click", () => {
    toggleModal(confirmModal, false);
    pendingPayload = null;
  });

  confirmYes?.addEventListener("click", async () => {
    if (!pendingPayload) {
      toggleModal(confirmModal, false);
      return;
    }
    confirmYes.setAttribute("disabled", "true");
    confirmYes.textContent = "Guardando...";
    try {
      const result = await fetchJSON(`/api/consultas/${slotId}/finalizar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          slotId,
          patientId,
          resumen: pendingPayload.resumen,
          diagnostico: pendingPayload.diagnostico,
          derivacion: pendingPayload.derivacion,
          tratamientos: pendingPayload.tratamientos,
          ordenExamenes: pendingPayload.exams,
        }),
      });
      feedback.hidden = false;
      feedback.textContent = result.message ?? "Consulta guardada.";
      errorBox.hidden = true;
      saveButton.setAttribute("disabled", "true");
      setTimeout(() => {
        window.location.href = "/trabajador/consultas";
      }, 800);
    } catch (error) {
      errorBox.hidden = false;
      errorBox.textContent = error instanceof Error ? error.message : "No pudimos guardar la consulta.";
    } finally {
      confirmYes.removeAttribute("disabled");
      confirmYes.textContent = "Si";
      toggleModal(confirmModal, false);
      pendingPayload = null;
    }
  });

  historyModal?.addEventListener("click", (event) => {
    if (event.target === historyModal || event.target?.dataset?.historyClose !== undefined) {
      toggleModal(historyModal, false);
    }
  });

  chronicModal?.addEventListener("click", (event) => {
    if (event.target === chronicModal || event.target?.dataset?.chronicClose !== undefined) {
      toggleModal(chronicModal, false);
    }
  });
</script>
