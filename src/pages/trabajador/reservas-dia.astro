---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const isDoctor = worker.cargo === "MEDICO";

if (!isDoctor && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const workerFullName = [
  worker.primer_nombre_trabajador,
  worker.segundo_nombre_trabajador,
  worker.apellido_p_trabajador,
  worker.apellido_m_trabajador,
]
  .filter(Boolean)
  .join(" ");

const startOfToday = new Date();
startOfToday.setHours(0, 0, 0, 0);
const endOfToday = new Date(startOfToday);
endOfToday.setHours(23, 59, 59, 999);

const todayReservations = await prisma.disponibilidadTrabajador.findMany({
  where: {
    id_trabajador: worker.id_trabajador,
    fecha: {
      gte: startOfToday,
      lt: endOfToday,
    },
    estado: {
      in: ["reservado", "confirmado"],
    },
  },
  include: {
    paciente: {
      select: {
        id_paciente: true,
        primer_nombre_paciente: true,
        segundo_nombre_paciente: true,
        apellido_p_paciente: true,
        apellido_m_paciente: true,
        correo_paciente: true,
        celular_paciente: true,
      },
    },
  },
  orderBy: { fecha: "asc" },
});

const statusLabels: Record<string, string> = {
  reservado: "Reservado",
  confirmado: "Confirmado",
};
---

<Layout title="Reservas del dia">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Agenda diaria</p>
        <h1 class="mt-3 text-3xl font-bold">Pacientes con reserva hoy</h1>
        <p class="mt-2 text-white/80">
          Profesional: <span class="font-semibold text-white">{workerFullName}</span>
        </p>
        <p class="mt-1 text-white/70">
          Especialidad: <span class="font-semibold text-white">{specialtyName}</span>
        </p>
        <p class="mt-4 text-sm text-white/60">
          Solo se muestran las reservas asignadas para la fecha de hoy. Usa esta vista para validar tu jornada.
        </p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a
            href="/trabajador"
            class="inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
          >
            Volver al panel
          </a>
          
        </div>
      </header>

      {todayReservations.length > 0 ? (
        <div class="space-y-4 rounded-3xl bg-white p-6 shadow-lg">
          <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <p class="text-sm font-semibold text-[#200934]">Reservas del dia</p>
              <p class="text-xs text-[#200934]/70">Pacientes agendados en tu agenda personal.</p>
            </div>
            <p class="text-xs font-semibold uppercase tracking-[0.2em] text-[#200934]/60">
              {todayReservations.length} {todayReservations.length === 1 ? "paciente" : "pacientes"}
            </p>
          </div>
          <ul class="space-y-4">
            {todayReservations.map((slot) => {
              const patient = slot.paciente;
              const patientName = patient
                ? [
                    patient.primer_nombre_paciente,
                    patient.segundo_nombre_paciente,
                    patient.apellido_p_paciente,
                    patient.apellido_m_paciente,
                  ]
                    .filter(Boolean)
                    .join(" ")
                : "Paciente pendiente";
              const statusLabel = statusLabels[slot.estado] ?? "Reservado";
              const slotTime = slot.fecha.toLocaleTimeString("es-CL", { timeStyle: "short" });

              return (
                <li class="rounded-3xl border border-[#200934]/10 bg-white p-5 shadow-sm">
                  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                    <div class="space-y-1">
                      <p class="text-lg font-semibold text-[#200934]">{patientName}</p>
                      <p class="text-sm text-[#200934]/70">Hora: {slotTime}</p>
                      <p class="text-xs font-semibold text-emerald-600">{statusLabel}</p>
                    </div>
                    {patient ? (
                      <div class="rounded-2xl bg-[#f4f1fb] p-4 text-sm text-[#200934]">
                        <p class="font-semibold">Contacto</p>
                        <p class="text-[#200934]/80">Correo: {patient.correo_paciente ?? "Sin correo"}</p>
                        <p class="text-[#200934]/80">Telefono: {patient.celular_paciente ?? "Sin telefono"}</p>
                      </div>
                    ) : null}
                  </div>
                </li>
              );
            })}
          </ul>
        </div>
      ) : (
        <p class="rounded-3xl border border-dashed border-[#200934]/20 bg-white p-6 text-sm text-[#200934]/70">
          No tienes pacientes con reserva para hoy.
        </p>
      )}
    </div>
  </section>
</Layout>
