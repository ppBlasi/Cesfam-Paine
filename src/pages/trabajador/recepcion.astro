---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";
import { normalizeRut } from "../../utils/rut";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
        id_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const specialtyName = worker.especialidad?.nombre_especialidad ?? "Sin especialidad";
const isReception = worker.cargo === "RECEPCION" || specialtyName === "Recepcion";

if (!isReception && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const rutQuery = Astro.url.searchParams.get("rut")?.trim() ?? "";
const normalizedRut = rutQuery ? normalizeRut(rutQuery) : "";

let patient = null;
let reservations = null;
let searchError = "";

if (normalizedRut) {
  patient = await prisma.paciente.findFirst({
    where: { rut_paciente: normalizedRut },
    select: {
      id_paciente: true,
      primer_nombre_paciente: true,
      segundo_nombre_paciente: true,
      apellido_p_paciente: true,
      apellido_m_paciente: true,
      correo_paciente: true,
      celular_paciente: true,
    },
  });

  if (!patient) {
    searchError = "No encontramos un paciente con ese RUT. Verifica la informacion ingresada.";
  } else {
    const legacyReservations = await prisma.reserva.findMany({
      where: { paciente: { some: { id_paciente: patient.id_paciente } } },
      include: {
        estado: true,
        fecha_hora: true,
      },
      orderBy: { fecha_reserva: "desc" },
      take: 10,
    });

    const slotReservations = await prisma.disponibilidadTrabajador.findMany({
      where: { id_paciente: patient.id_paciente },
      include: {
        trabajador: {
          select: {
            primer_nombre_trabajador: true,
            segundo_nombre_trabajador: true,
            apellido_p_trabajador: true,
            apellido_m_trabajador: true,
            especialidad: { select: { nombre_especialidad: true } },
          },
        },
      },
      orderBy: { fecha: "desc" },
      take: 10,
    });

    reservations = [
      ...legacyReservations.map((reservation) => ({
        kind: "legacy" as const,
        id: reservation.id_reserva,
        dateLabel: reservation.fecha_reserva,
        statusLabel: reservation.estado?.nombre_estado ?? "Pendiente",
        datetime: reservation.fecha_hora?.fecha_hora ?? null,
        doctorName: null,
        specialty: null,
      })),
      ...slotReservations.map((slot) => ({
        kind: "slot" as const,
        id: slot.id_disponibilidad,
        dateLabel: slot.fecha.toLocaleDateString("es-CL", { dateStyle: "medium" }),
        statusLabel: slot.estado.charAt(0).toUpperCase() + slot.estado.slice(1),
        datetime: slot.fecha,
        doctorName: [
          slot.trabajador.primer_nombre_trabajador,
          slot.trabajador.segundo_nombre_trabajador,
          slot.trabajador.apellido_p_trabajador,
          slot.trabajador.apellido_m_trabajador,
        ]
          .filter(Boolean)
          .join(" "),
        specialty: slot.trabajador.especialidad?.nombre_especialidad ?? "Medicina General",
      })),
    ]
      .sort((a, b) => {
        const dateA = a.datetime ? new Date(a.datetime).getTime() : 0;
        const dateB = b.datetime ? new Date(b.datetime).getTime() : 0;
        return dateB - dateA;
      })
      .slice(0, 10);
  }
}

const formatDateTime = (value: Date | null | undefined) =>
  value ? value.toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" }) : "Sin asignar";

const patientFullName = patient
  ? [
      patient.primer_nombre_paciente,
      patient.segundo_nombre_paciente,
      patient.apellido_p_paciente,
      patient.apellido_m_paciente,
    ]
      .filter(Boolean)
      .join(" ")
  : null;
---

<Layout title="Herramientas de recepcion">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-5xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Modulo de recepcion</p>
        <h1 class="mt-3 text-3xl font-bold">Consulta de reservas por paciente</h1>
        <p class="mt-2 text-white/80">
          Profesional: <span class="font-semibold text-white">{worker.primer_nombre_trabajador} {worker.apellido_p_trabajador}</span>
        </p>
        <p class="mt-1 text-white/70">
          Especialidad: <span class="font-semibold text-white">{specialtyName}</span>
        </p>
        <p class="mt-4 text-sm text-white/60">
          Ingresa el RUT del paciente para revisar sus proximas reservas. Esta herramienta solo es visible para personal de recepcion.
        </p>
        <a
          href="/trabajador"
          class="mt-6 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver al panel principal
        </a>
      </header>

      <form class="rounded-3xl bg-white p-6 shadow-lg" method="GET">
        <label class="flex flex-col gap-2 text-sm font-semibold text-[#200934]">
          RUT del paciente
          <input
            type="text"
            name="rut"
            placeholder="Ej: 11.111.111-1"
            value={rutQuery}
            class="rounded-2xl border border-[#200934]/20 px-4 py-3 text-base text-[#200934] focus:border-[#200934] focus:outline-none"
            required
          />
        </label>
        <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <p class="text-xs text-[#200934]/70">Usa puntos y guion o solo el numero, nosotros lo normalizaremos.</p>
          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-2xl bg-[#321355] px-5 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
          >
            Buscar reservas
          </button>
        </div>
      </form>

      {searchError ? (
        <p class="rounded-3xl bg-rose-100 px-4 py-3 text-sm font-semibold text-rose-700">{searchError}</p>
      ) : null}

      {normalizedRut && !searchError ? (
        <>
          {patient ? (
            <section class="rounded-3xl bg-white p-6 shadow-lg">
          <div class="flex flex-col gap-2 border-b border-[#200934]/10 pb-4">
            <h2 class="text-xl font-semibold text-[#200934]">Paciente encontrado</h2>
            <p class="text-sm text-[#200934]/70">
              Nombre completo: <span class="font-semibold text-[#200934]">{patientFullName}</span>
            </p>
            <p class="text-sm text-[#200934]/70">Correo: {patient.correo_paciente || "Sin informacion"}</p>
            <p class="text-sm text-[#200934]/70">Telefono: {patient.celular_paciente || "Sin informacion"}</p>
            <div class="mt-3">
              <a
                href={`/trabajador/recepcion/reserva?rut=${encodeURIComponent(normalizedRut)}`}
                class="inline-flex items-center rounded-2xl bg-[#321355] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#200934]"
              >
                Reservar hora
              </a>
            </div>
          </div>

              {reservations && reservations.length > 0 ? (
                <ul class="mt-4 space-y-3" data-reservations-list>
                  {reservations.map((reservation) => (
                    <li
                      class="rounded-2xl border border-[#200934]/10 px-4 py-3"
                      data-reservation
                      data-kind={reservation.kind}
                      data-reservation-id={reservation.id}
                    >
                      <p class="text-sm font-semibold text-[#200934]">{reservation.dateLabel}</p>
                      <p class="text-xs text-[#200934]/70">
                        Estado: <span class="font-semibold text-[#200934]">{reservation.statusLabel}</span>
                      </p>
                      <p class="text-xs text-[#200934]/70">
                        Fecha y hora: <span class="font-semibold text-[#200934]">{formatDateTime(reservation.datetime)}</span>
                      </p>
                      {reservation.doctorName ? (
                        <p class="text-xs text-[#200934]/70">
                          Profesional: <span class="font-semibold text-[#200934]">{reservation.doctorName}</span> ({reservation.specialty})
                        </p>
                      ) : null}
                      {reservation.kind === "slot" ? (
                        <div class="mt-3 flex flex-wrap gap-2" data-action-container>
                          <button
                            type="button"
                            class="rounded-xl bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700 transition hover:bg-rose-200"
                            data-remove-button
                          >
                            Eliminar
                          </button>
                        </div>
                      ) : null}
                    </li>
                  ))}
                </ul>
              ) : (
                <p class="mt-4 rounded-2xl bg-[#f4f1fb] px-4 py-3 text-sm text-[#200934]">
                  El paciente no registra reservas recientes o confirmadas en el sistema.
                </p>
              )}
            </section>
          ) : null}
        </>
      ) : null}
    </div>
  </section>
</Layout>

{reservations && reservations.length > 0 ? (
  <script type="module">
    const list = document.querySelector("[data-reservations-list]");
    if (list) {
      list.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;

        const actionContainer = target.closest("[data-action-container]");
        if (!actionContainer) return;

        const item = actionContainer.closest("[data-reservation]");
        if (!item) return;

        const kind = item.dataset.kind;
        const reservationId = Number(item.dataset.reservationId);
        if (kind !== "slot" || !Number.isFinite(reservationId)) {
          return;
        }

        const removeButton = actionContainer.querySelector("[data-remove-button]");
        const confirmYes = actionContainer.querySelector("[data-confirm-yes]");
        const confirmNo = actionContainer.querySelector("[data-confirm-no]");
        const createConfirmButtons = () => {
          actionContainer.innerHTML = "";
          const text = document.createElement("p");
          text.className = "text-xs font-semibold text-[#200934]";
          text.textContent = "Â¿Eliminar esta reserva?";

          const yesButton = document.createElement("button");
          yesButton.type = "button";
          yesButton.textContent = "Si";
          yesButton.className =
            "rounded-xl bg-rose-600 px-3 py-1 text-xs font-semibold text-white transition hover:bg-rose-700";
          yesButton.dataset.confirmYes = "true";

          const noButton = document.createElement("button");
          noButton.type = "button";
          noButton.textContent = "No";
          noButton.className =
            "rounded-xl bg-[#f4f1fb] px-3 py-1 text-xs font-semibold text-[#200934] transition hover:bg-[#e2d9f2]";
          noButton.dataset.confirmNo = "true";

          actionContainer.append(text, yesButton, noButton);
        };

        if (target.dataset.removeButton !== undefined) {
          createConfirmButtons();
          return;
        }

        if (target.dataset.confirmNo !== undefined) {
          actionContainer.innerHTML = "";
          const button = document.createElement("button");
          button.type = "button";
          button.textContent = "Eliminar";
          button.className =
            "rounded-xl bg-rose-100 px-3 py-1 text-xs font-semibold text-rose-700 transition hover:bg-rose-200";
          button.dataset.removeButton = "true";
          actionContainer.append(button);
          return;
        }

        if (target.dataset.confirmYes !== undefined) {
          target.setAttribute("disabled", "true");
          target.textContent = "Eliminando...";
          try {
            const response = await fetch("/api/recepcion/eliminar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ disponibilidadId: reservationId }),
            });
            const result = await response.json().catch(() => null);
            if (!response.ok || !result) {
              throw new Error(result?.error ?? "No pudimos eliminar la reserva.");
            }
            item.remove();
          } catch (err) {
            console.error(err);
            target.removeAttribute("disabled");
            target.textContent = "Si";
            alert(err instanceof Error ? err.message : "Error inesperado al eliminar la reserva.");
          }
        }
      });
    }
  </script>
) : null}
