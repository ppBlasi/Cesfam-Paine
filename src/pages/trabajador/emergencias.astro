---
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

if (!user.isWorker && !user.isAdmin) {
  return Astro.redirect("/");
}

const worker = await prisma.trabajador.findFirst({
  where: { rut_trabajador: user.rut },
  include: {
    especialidad: {
      select: {
        nombre_especialidad: true,
      },
    },
  },
});

if (!worker) {
  return Astro.redirect(user.isAdmin ? "/admin" : "/perfil");
}

const isNurse =
  worker.cargo === "MEDICO" && worker.especialidad?.nombre_especialidad === "Enfermeria";

if (!isNurse && !user.isAdmin) {
  return Astro.redirect("/trabajador");
}

const emergencies = await prisma.emergencia.findMany({
  orderBy: { createdAt: "desc" },
  take: 50,
});

const attendedRows = await prisma.$queryRaw<Array<{ emergencia_id: bigint }>>`
  select emergencia_id from emergency_attentions
`;
const attendedSet = new Set(attendedRows.map((row) => row.emergencia_id.toString()));
const pendingEmergencies = emergencies.filter((item) => !attendedSet.has(item.id.toString()));
---

<Layout title="Emergencias">
  <section class="bg-gradient-to-b from-[#f4f1fb] to-[#e9e2ff] py-12">
    <div class="mx-auto flex max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-[#200934] px-6 py-8 text-white shadow-xl">
        <p class="text-sm uppercase tracking-[0.35em] text-white/70">Enfermeria</p>
        <h1 class="mt-3 text-3xl font-bold">Ingresos de emergencia</h1>
        <p class="mt-2 text-white/80">
          Ultimos registros enviados por recepcion. Ordenados del mas reciente al mas antiguo.
        </p>
        <a
          href="/trabajador"
          class="mt-4 inline-flex items-center justify-center rounded-2xl bg-white/15 px-4 py-2 text-sm font-semibold text-white transition hover:bg-white/25"
        >
          Volver al panel
        </a>
      </header>

      {pendingEmergencies.length > 0 ? (
        <div class="grid gap-4 md:grid-cols-2">
          {pendingEmergencies.map((emergency) => (
            <article class="rounded-3xl border border-[#200934]/10 bg-white p-5 shadow-sm">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-lg font-semibold text-[#200934]">{emergency.fullName}</p>
                  <p class="text-sm text-[#200934]/70">RUT: {emergency.rut}</p>
                  <p class="text-sm text-[#200934]/70">Telefono: {emergency.phone}</p>
                  <p class="text-sm text-[#200934]/70">Edad: {emergency.age}</p>
                  <p class="text-sm text-[#200934]/70">
                    Fecha de nacimiento: {new Date(emergency.birthdate).toLocaleDateString("es-CL")}
                  </p>
                  <p class="text-sm text-[#200934]/70">Sexo: {emergency.sex}</p>
                  <p class="text-sm text-[#200934]/70">Direccion: {emergency.address}</p>
                </div>
                <a
                  href={`/trabajador/emergencias/iniciar?id=${emergency.id}`}
                  class="mt-1 inline-flex items-center justify-center rounded-2xl bg-[#321355] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#3d1a6b] md:mt-0"
                >
                  Iniciar emergencia
                </a>
              </div>
              <p class="mt-3 text-xs text-[#200934]/60">
                Registrado: {new Date(emergency.createdAt).toLocaleString("es-CL", { dateStyle: "medium", timeStyle: "short" })}
              </p>
            </article>
          ))}
        </div>
      ) : (
        <p class="rounded-3xl border border-dashed border-[#200934]/20 bg-white/70 p-6 text-sm text-[#200934]/70">
          Aun no hay ingresos de emergencia registrados por recepcion.
        </p>
      )}
    </div>
  </section>
</Layout>
