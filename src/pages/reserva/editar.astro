---
import ReserveScheduler from "../../components/ReserveScheduler.vue";
import Layout from "../../layouts/Layout.astro";
import { prisma } from "../../lib/prisma";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login");
}

const title = "Editar hora reservada";
const availabilityId = Number(Astro.url.searchParams.get("availabilityId"));
const specialtyParam = Astro.url.searchParams.get("specialty") ?? "";

if (!Number.isInteger(availabilityId) || availabilityId <= 0) {
  return Astro.redirect("/perfil");
}

const patient = await prisma.paciente.findFirst({
  where: { rut_paciente: user.rut },
  select: {
    primer_nombre_paciente: true,
    segundo_nombre_paciente: true,
    apellido_p_paciente: true,
    apellido_m_paciente: true,
  },
});

const patientName = patient
  ? [
      patient.primer_nombre_paciente,
      patient.segundo_nombre_paciente,
      patient.apellido_p_paciente,
      patient.apellido_m_paciente,
    ]
      .filter(Boolean)
      .join(" ")
  : "";
---

<Layout title={title}>
  <section class="bg-[#f4f1fb] py-10">
    <div class="mx-auto flex w-full max-w-6xl flex-col gap-8 px-4 sm:px-6">
      <header class="rounded-3xl bg-gradient-to-r from-[#200934] via-[#321355] to-[#200934] px-6 py-8 text-white shadow-2xl">
        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-white/70">Reagendar</p>
        <h1 class="mt-3 text-3xl font-bold">Editar tu hora</h1>
        <p class="mt-2 max-w-2xl text-white/80">
          Selecciona una nueva fecha y hora en la misma especialidad. Al confirmar, actualizaremos tu reserva.
        </p>
        <a
          href="/perfil"
          class="mt-4 inline-flex items-center rounded-2xl border border-white/30 px-4 py-2 text-sm font-semibold transition hover:bg-white/10"
        >
          Volver al perfil
        </a>
      </header>

      <ReserveScheduler
        client:load
        patientName={patientName ?? ""}
        rescheduleMode={true}
        rescheduleAvailabilityId={availabilityId}
        rescheduleSpecialty={specialtyParam ?? ""}
      />
    </div>
  </section>
</Layout>
